<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Intelligence Hub V21.21 - Forensic Trace</title>
    <!-- PRODUCTION LIBS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&display=swap');
        body { font-family: 'Inter', sans-serif; background-color: #f8fafc; color: #0f172a; text-align: left; margin: 0; }
        .custom-scrollbar::-webkit-scrollbar { width: 5px; height: 5px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: #f1f5f9; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 10px; }
        .urgency-badge { padding: 2px 8px; border-radius: 9999px; font-size: 10px; font-weight: 900; text-transform: uppercase; border: 1px solid transparent; }
        .grade-a { background-color: #ef4444; color: white; border-color: #fee2e2; }
        .grade-b { background-color: #f97316; color: white; }
        .grade-c { background-color: #3b82f6; color: white; }
        .consultancy-card { border-left: 4px solid #8b5cf6; background-color: #f5f3ff; }
        .gap-card { border-left: 4px solid #10b981; background-color: #f0fdf4; }
        .progress-shimmer { background: linear-gradient(90deg, rgba(255,255,255,0) 0%, rgba(255,255,255,0.4) 50%, rgba(255,255,255,0) 100%); background-size: 200% 100%; animation: shimmer 1.5s infinite; }
        @keyframes shimmer { 0% { background-position: 200% 0; } 100% { background-position: -200% 0; } }
        #boot-loader { position: fixed; inset: 0; background: #f8fafc; display: flex; flex-direction: column; align-items: center; justify-content: center; z-index: 99999; transition: opacity 0.5s ease; }
        .trace-line { border-left: 2px solid #3b82f6; padding-left: 8px; margin-bottom: 4px; animation: slideIn 0.3s ease-out; }
        @keyframes slideIn { from { opacity: 0; transform: translateX(-10px); } to { opacity: 1; transform: translateX(0); } }
    </style>
</head>
<body class="p-4 md:p-8 text-left">
    <!-- Boot Sequence Loader -->
    <div id="boot-loader">
        <div class="font-black text-slate-400 uppercase tracking-widest text-[10px] italic animate-pulse mb-4">
            Initializing Intelligence Hub V21.21...
        </div>
        <button onclick="localStorage.clear(); window.location.reload();" class="text-[8px] font-bold text-slate-300 uppercase hover:text-red-400 transition-colors tracking-tighter">
            System Hang? Click to Force Reset Data
        </button>
    </div>

    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useMemo, useCallback } = React;

        // Resilient Icon Helper
        const Icon = ({ name, size = 16, className = "" }) => {
            useEffect(() => {
                if (window.lucide) {
                    try { window.lucide.createIcons(); } catch (e) {}
                }
            }, [name]);
            return <i data-lucide={name} className={className} style={{ width: size, height: size, display: 'inline-flex', alignItems: 'center', justifyContent: 'center' }}></i>;
        };

        const API_BASE = "https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent";

        // --- STABILITY UTILS ---
        const safeJsonLoad = (key, fallback) => {
            try {
                if (typeof window === 'undefined') return fallback;
                const item = localStorage.getItem(key);
                if (!item) return fallback;
                const parsed = JSON.parse(item);
                if (!parsed) return fallback;
                if (Array.isArray(fallback) && !Array.isArray(parsed)) return fallback;
                return parsed;
            } catch (e) { return fallback; }
        };

        const cleanName = (n) => n ? String(n).toLowerCase().split('(')[0].replace(/limited|ltd|trust|uk|the|group|charity|foundation|school/gi, '').replace(/[^a-z0-9]/g, '').trim() : '';

        const splitLine = (str) => {
            const res = []; let cell = ''; let inQ = false;
            if (!str) return res;
            for (let i = 0; i < str.length; i++) {
                const char = str[i];
                if (char === '"') inQ = !inQ;
                else if (char === ',' && !inQ) { res.push(cell.trim()); cell = ''; }
                else if (char !== '\r') cell += char;
            }
            res.push(cell.trim()); return res;
        };

        const getGradeStyle = (grade) => {
            const g = String(grade || 'C').toUpperCase();
            if (g.startsWith('A')) return 'grade-a';
            if (g === 'B') return 'grade-b';
            return 'grade-c';
        };

        // --- SUB-COMPONENTS ---
        const DeskTable = ({ items, teamActions, onClaim }) => (
            <table className="w-full text-left border-collapse">
                <thead>
                    <tr className="border-b border-slate-200">
                        <th className="py-4 text-[10px] font-black uppercase text-slate-400 px-2 text-left">Entity & Regional Map</th>
                        <th className="py-4 text-[10px] font-black uppercase text-slate-400 px-2 text-left">Signal Window</th>
                        <th className="py-4 text-[10px] font-black uppercase text-slate-400 text-center">Risk</th>
                        <th className="py-4 text-[10px] font-black uppercase text-slate-400 px-2 w-[45%] text-left">Strategic Forensic Intelligence</th>
                        <th className="py-4 text-[10px] font-black uppercase text-slate-400 text-right px-2">Loxo Action</th>
                    </tr>
                </thead>
                <tbody className="divide-y divide-slate-100">
                    {(items || []).map((l, i) => {
                        if (!l) return null;
                        const actionId = l.charity ? String(l.charity).replace(/[^a-zA-Z0-9]/g, '-') : 'row-' + i;
                        const action = teamActions[actionId];
                        return (
                            <tr key={i} className={action ? 'opacity-40 grayscale text-left' : 'text-left hover:bg-slate-50/50'}>
                                <td className="py-6 px-2 font-black uppercase text-[11px] text-slate-900 leading-tight">
                                    {l.charity || 'Target Entity'}
                                    <div className="flex gap-1 mt-1">
                                        <span className="text-[7px] text-blue-500 font-bold uppercase">{l.cause || 'Sector Registry'}</span>
                                        <span className="text-[7px] text-slate-400 font-bold uppercase border-l border-slate-200 pl-1">{l.location || 'UK'}</span>
                                    </div>
                                    <div className="text-[6px] text-slate-300 font-bold mt-1 uppercase italic tracking-tighter">Forensic Sync: {l.auditDate || 'Pending Cycle'}</div>
                                </td>
                                <td className="py-6 px-2">
                                    <div className="font-bold text-[11px] text-blue-600 uppercase italic leading-none">{l.title || 'Signal Trace'}</div>
                                    <div className="flex gap-2 mt-2">
                                        <div className="flex flex-col bg-slate-50 px-1.5 py-0.5 rounded">
                                            <span className="text-[5px] font-black text-slate-400 uppercase">Live</span>
                                            <span className="text-[8px] text-slate-600 font-black uppercase">{l.adDate || '??/??'}</span>
                                        </div>
                                        <div className="flex flex-col bg-red-50 px-1.5 py-0.5 rounded">
                                            <span className="text-[5px] font-black text-red-300 uppercase">Deadline</span>
                                            <span className="text-[8px] text-red-600 font-black uppercase italic">{l.closingDate || '??/??'}</span>
                                        </div>
                                    </div>
                                    <div className="mt-2 text-[8px] font-black text-slate-400 uppercase italic">Sal: {l.salary || 'Competitive'}</div>
                                </td>
                                <td className="py-6 text-center">
                                    <span className={'urgency-badge ' + getGradeStyle(l.grade)}>{l.grade === 'A' ? 'CRITICAL' : l.grade === 'B' ? 'STRATEGIC' : 'MONITOR'}</span>
                                </td>
                                <td className="py-6 px-2 text-[10px] font-medium leading-relaxed italic text-slate-500 border-l border-slate-50 pl-6 text-left">
                                    <div className="bg-slate-900 text-white inline-block px-2 py-0.5 rounded text-[7px] font-black uppercase mb-2 tracking-tighter">
                                        LOXO CONTACT: {l.reportsTo || (l.ceoFallback ? 'CEO FALLBACK: ' + l.ceoFallback : 'STAKEHOLDER MISSING')}
                                    </div>
                                    <div className="font-bold text-slate-800 not-italic mb-1 uppercase text-[8px] tracking-widest text-emerald-600 flex items-center gap-1">
                                        <Icon name="shield-alert" size={10} /> {l.gapType || 'Forensic Trace'}
                                    </div>
                                    {l.behaviorFlag || 'Automated intelligence discovery.'}
                                    <div className="mt-2 text-[8px] font-black text-blue-500 uppercase tracking-widest leading-none italic">Verified via: {l.source || 'Intelligence Feed'}</div>
                                </td>
                                <td className="py-6 px-2 text-right">
                                    <div className="flex items-center justify-end gap-2 text-right">
                                        <a href={l.link || '#'} target="_blank" rel="noopener noreferrer" className="p-3 bg-slate-100 rounded-2xl hover:bg-slate-200 transition-all shadow-sm">
                                            <Icon name="external-link" size={16} className="text-slate-400" />
                                        </a>
                                        {action ? (
                                            <span className="text-[8px] font-black text-emerald-600 uppercase italic px-4">Synced: {action.owner}</span>
                                        ) : (
                                            <button onClick={() => onClaim(l.charity, 'Tim', l.reportsTo || l.ceoFallback)} className="bg-blue-600 text-white text-[9px] font-black px-4 py-2 rounded-xl uppercase shadow-lg hover:bg-blue-700 active:scale-95 transition-all">Assign to Contact</button>
                                        )}
                                    </div>
                                </td>
                            </tr>
                        );
                    })}
                </tbody>
            </table>
        );

        // --- MAIN APP ---
        function App() {
            const [registry, setRegistry] = useState(() => safeJsonLoad('hub_registry', []));
            const [intel, setIntel] = useState(() => safeJsonLoad('hub_intel', []));
            const [teamActions, setTeamActions] = useState(() => safeJsonLoad('hub_actions', {}));
            const [connections, setConnections] = useState(() => safeJsonLoad('hub_connections', []));
            const [schools, setSchools] = useState(() => safeJsonLoad('hub_schools', []));
            
            const [isAdmin, setIsAdmin] = useState(true);
            const [activeModal, setActiveModal] = useState(null); 
            const [searchQuery, setSearchQuery] = useState('');
            const [logs, setLogs] = useState(['[SYSTEM] V21.21 Forensic Trace Active. Real-time monitoring ready.']);
            const [trace, setTrace] = useState([]); // Live Investigative Trace
            const [progress, setProgress] = useState({ active: false, percent: 0, status: '' });
            const [emailInput, setEmailInput] = useState('');

            const [leadFilters, setLeadFilters] = useState({ cause: 'all', location: 'all' });
            
            const [keys, setKeys] = useState(() => ({
                gemini: (typeof window !== 'undefined' ? localStorage.getItem('hub_gemini_key') : '') || '',
                loxo: (typeof window !== 'undefined' ? localStorage.getItem('hub_loxo_key') : '') || '',
                cc: (typeof window !== 'undefined' ? localStorage.getItem('hub_cc_key') : '') || ""
            }));

            // Auto-Persistence
            useEffect(() => {
                if (registry.length > 0) localStorage.setItem('hub_registry', JSON.stringify(registry));
            }, [registry]);

            useEffect(() => {
                if (intel.length > 0) localStorage.setItem('hub_intel', JSON.stringify(intel));
            }, [intel]);

            useEffect(() => {
                const loader = document.getElementById('boot-loader');
                if (loader) {
                    loader.style.opacity = '0';
                    setTimeout(() => loader.style.display = 'none', 500);
                }
            }, []);

            const addLog = useCallback((m) => setLogs(p => ['[' + new Date().toLocaleTimeString() + '] ' + m, ...p].slice(0, 50)), []);
            const addTrace = useCallback((m) => setTrace(p => [m, ...p].slice(0, 10)), []);

            const resetMemory = () => {
                if (window.confirm("Confirm Reset: This will wipe all discovered leads and registry items.")) {
                    localStorage.clear();
                    window.location.reload();
                }
            };

            const handleImport = (e) => {
                const files = Array.from(e.target.files);
                if (files.length === 0) return;
                setProgress({ active: true, percent: 5, status: 'Auditing data layers...' });
                
                let currentFileIndex = 0;
                const processNextFile = () => {
                    if (currentFileIndex >= files.length) {
                        setProgress({ active: true, percent: 100, status: 'Sync Complete.' });
                        setTimeout(() => setProgress({ active: false, percent: 0, status: '' }), 1500);
                        return;
                    }

                    const file = files[currentFileIndex];
                    const reader = new FileReader();
                    reader.onload = (event) => {
                        try {
                            const text = event.target.result;
                            const lines = text.split(/\n/).filter(l => l.trim());
                            if (lines.length < 1) { currentFileIndex++; processNextFile(); return; }
                            const headers = splitLine(lines[0].toLowerCase());
                            const data = lines.slice(1).map(l => {
                                const vals = splitLine(l);
                                let obj = {};
                                headers.forEach((h, i) => obj[h.replace(/"/g, '').trim()] = (vals[i] || '').replace(/^"|"$/g, ''));
                                return obj;
                            });

                            const s = data[0] || {};
                            if (s['first name'] && s['company']) {
                                setConnections(data); localStorage.setItem('hub_connections', JSON.stringify(data));
                            } else if (s['establishmentname'] || s['headfirstname']) {
                                setSchools(data); localStorage.setItem('hub_schools', JSON.stringify(data));
                            } else if (s['agencyscore'] || s['detailedreason']) {
                                const historical = data.map(r => ({
                                    charityName: r['charity'] || r['organisation'],
                                    jobs: [{
                                        title: r['jobtitle'] || r['job title'] || 'Strategic Lead',
                                        salary: r['salary'] || 'TBC',
                                        link: r['link'] || r['url'] || '#',
                                        since: r['tenuresince'] || 'History',
                                        reportsTo: r['reportsto'] || 'CEO',
                                        grade: r['agencyscore'] ? 'A' : 'B',
                                        type: (r['salary'] || '').toLowerCase().includes('day') ? 'consultancy' : 'permanent',
                                        behaviorFlag: r['detailedreason'] || r['reason'] || 'Archive Trace.',
                                        source: 'Strategic History'
                                    }]
                                }));
                                setIntel(prev => [...historical, ...prev]);
                            } else {
                                const isLeads = (s['job title'] || s['title']);
                                if (isLeads) {
                                    const active = data.map(r => ({
                                        charityName: r['organisation'] || r['charity'],
                                        jobs: [{
                                            title: r['job title'] || r['title'], salary: r['salary'] || 'TBC',
                                            link: r['link'] || r['url'] || '#',
                                            since: r['advertised since'] || 'Recently',
                                            reportsTo: r['reports to'] || 'CEO', grade: 'C',
                                            type: (r['salary'] || '').toLowerCase().includes('day') ? 'consultancy' : 'permanent',
                                            behaviorFlag: r['note'] || 'Import Lead.', source: 'CSV Intake'
                                        }]
                                    }));
                                    setIntel(prev => [...active, ...prev]);
                                } else {
                                    setRegistry(prev => {
                                        const newReg = [...prev];
                                        data.forEach(r => {
                                            const n = r['charity name'] || r['organisation'] || r['name'] || r['charity_name'];
                                            if (!n) return;
                                            const idx = newReg.findIndex(m => cleanName(m.name) === cleanName(n));
                                            if (idx > -1) {
                                                newReg[idx].loxo = (r['loxo status'] === 'Client' ? 'Client' : newReg[idx].loxo);
                                            } else {
                                                newReg.push({ 
                                                    name: n, id: r['charity number'], loxo: (r['loxo status'] || 'Target'), 
                                                    cause: r['cause'] || 'Sector', location: r['head_office_location'] || 'UK',
                                                    lastGeneralSweep: null, lastDeepAudit: null 
                                                });
                                            }
                                        });
                                        return newReg;
                                    });
                                }
                            }
                            currentFileIndex++;
                            setProgress({ active: true, percent: Math.round((currentFileIndex / files.length) * 100), status: 'Merging ' + file.name });
                            setTimeout(processNextFile, 100);
                        } catch (err) { currentFileIndex++; processNextFile(); }
                    };
                    reader.readAsText(file);
                };
                processNextFile();
            };

            const stats = useMemo(() => {
                const list = (intel || []).flatMap(i => (i && Array.isArray(i.jobs)) ? i.jobs : []);
                return {
                    registry: (registry || []).length,
                    leads: list.filter(j => j && j.type === 'permanent').length,
                    consult: list.filter(j => j && j.type === 'consultancy').length,
                    gaps: list.filter(j => j && j.type === 'gap').length
                };
            }, [registry, intel]);

            const filteredList = (registry || []).filter(c => c && c.name && String(c.name).toLowerCase().includes(searchQuery.toLowerCase()));

            const deskItems = useMemo(() => {
                if (!activeModal || activeModal === 'settings') return [];
                const items = [];
                (intel || []).forEach(e => (e?.jobs || []).forEach(j => { 
                    if (j && j.type === activeModal) {
                        const regData = registry.find(r => cleanName(r.name) === cleanName(e.charityName)) || {};
                        items.push({ 
                            charity: e.charityName, auditDate: e.foundAt, 
                            cause: regData.cause || 'Sector', location: regData.location || 'UK',
                            ...j 
                        });
                    }
                }));
                return items.filter(item => {
                    const causeMatch = leadFilters.cause === 'all' || item.cause === leadFilters.cause;
                    const locationMatch = leadFilters.location === 'all' || item.location === leadFilters.location;
                    return causeMatch && locationMatch;
                });
            }, [activeModal, intel, registry, leadFilters]);

            const claim = (n, u, contact) => {
                const id = String(n).replace(/[^a-zA-Z0-9]/g, '-');
                const upd = { ...teamActions, [id]: { owner: u, date: new Date().toISOString(), contact: contact } };
                setTeamActions(upd); localStorage.setItem('hub_actions', JSON.stringify(upd));
                addLog(u + ' assigned job to Loxo: ' + contact);
            };

            const runGrounding = async (name, mode = 'deep') => {
                if (!keys.gemini) { setActiveModal('settings'); return; }
                addTrace(`INIT: ${mode.toUpperCase()} sweep for ${name}...`);
                
                const promptDeep = `Investigate UK Charity ${name}. 
                    1. VACANCIES: Search aggregation boards (CharityJob, ThirdSector) AND 'vacancies' pages. AGGRESSIVELY hunt for 'Day rate', 'Interim', 'Maternity', 'Contract', 'Rolling', 'Immediate start'.
                    2. RISKS: Mandatory check of Charity Commission. Identify Legacy Gap (Legacy <5% of IG pot). Over-reliance on grants (>70%). Section 114 risk. Declining income trends.
                    3. STAKEHOLDERS: Find the 'CEO Name'.
                    4. DATES: Find specific post and closing dates.
                    Return JSON ONLY: {"jobs": [{"title": "Role", "adDate": "DD/MM", "closingDate": "DD/MM", "link": "url", "grade": "A|B|C", "type": "permanent|consultancy|gap", "gapType": "Category", "behaviorFlag": "Deep narrative using specific crisis markers found", "reportsTo": "Mgr", "ceoFallback": "Name", "salary": "£"}]}`;

                const promptPulse = `Check ${name} and CharityJob for active senior fundraising vacancies (>£40k). Return JSON ONLY: {"active": boolean, "jobs": []}`;

                try {
                    addTrace(`SEARCHING: Cross-referencing 5 UK Job Boards for ${name}...`);
                    const res = await fetch(API_BASE + "?key=" + keys.gemini, {
                        method: "POST",
                        headers: { "Content-Type": "application/json" },
                        body: JSON.stringify({ contents: [{ parts: [{ text: mode === 'deep' ? promptDeep : promptPulse }] }], tools: [{ "google_search": {} }] })
                    });
                    const data = await res.json();
                    const rawText = data?.candidates?.[0]?.content?.parts?.[0]?.text || "{\"jobs\": []}";
                    const parsed = JSON.parse(rawText.replace(/```json/g, '').replace(/```/g, '').trim());
                    
                    if (parsed.jobs && parsed.jobs.length > 0) {
                        addTrace(`SUCCESS: Found ${parsed.jobs.length} leads for ${name}.`);
                        setIntel(prev => [{ charityName: name, foundAt: new Date().toLocaleDateString(), jobs: parsed.jobs }, ...prev]);
                        addLog(`${mode === 'deep' ? 'Forensic' : 'Pulse'} Secured: ${name}`);
                    } else {
                        addTrace(`CLEAN: No active signals detected for ${name}.`);
                    }

                    setRegistry(prev => prev.map(c => c.name === name ? { 
                        ...c, [mode === 'deep' ? 'lastDeepAudit' : 'lastGeneralSweep']: new Date().toISOString() 
                    } : c));
                } catch (err) { addTrace(`ERROR: Bypassed logic for ${name}.`); }
            };

            const startBatchSweep = async () => {
                if (!keys.gemini) { setActiveModal('settings'); return; }
                
                const pulseTargets = [...registry].sort((a,b) => (a.lastGeneralSweep ? new Date(a.lastGeneralSweep) : 0) - (b.lastGeneralSweep ? new Date(b.lastGeneralSweep) : 0)).slice(0, 500);
                if (pulseTargets.length > 0) {
                    addLog('Pulse Phase: 500 Targets...');
                    for (let i = 0; i < pulseTargets.length; i += 5) {
                        setProgress({ active: true, percent: Math.round((i/pulseTargets.length)*50), status: 'Pulse: ' + (i+1) + '/' + pulseTargets.length });
                        await Promise.all(pulseTargets.slice(i, i+5).map(t => runGrounding(t.name, 'pulse')));
                    }
                }

                const auditTargets = [...registry].sort((a,b) => (a.lastDeepAudit ? new Date(a.lastDeepAudit) : 0) - (b.lastDeepAudit ? new Date(b.lastDeepAudit) : 0)).slice(0, 10);
                addLog('Audit Phase: 10 Targets...');
                for (let i = 0; i < auditTargets.length; i++) {
                    const char = auditTargets[i];
                    setProgress({ active: true, percent: 50 + Math.round(((i + 1) / auditTargets.length) * 50), status: 'Forensic: ' + char.name });
                    await runGrounding(char.name, 'deep');
                    await new Promise(r => setTimeout(r, 2000));
                }

                addLog('Systematic Cycle Finalized.');
                setProgress({ active: true, percent: 100, status: 'System Cycle Complete.' });
                setTimeout(() => setProgress({ active: false, percent: 0, status: '' }), 1500);
            };

            const bulkExportIntel = () => {
                let csv = "Type,Entity,Cause,Location,Role,Salary,AdDate,ClosingDate,StrategicReason,Link\n";
                (intel || []).forEach(e => (e?.jobs || []).forEach(j => {
                    const regData = registry.find(r => cleanName(r.name) === cleanName(e.charityName)) || {};
                    csv += `"${j.type}","${e.charityName}","${regData.cause || ''}","${regData.location || ''}","${j.title}","${j.salary || ''}","${j.adDate || ''}","${j.closingDate || ''}","${j.behaviorFlag}","${j.link}"\n`;
                }));
                const blob = new Blob([csv], { type: 'text/csv' });
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement("a");
                a.href = url; a.download = `Registry_Audit_${new Date().toLocaleDateString()}.csv`;
                a.click();
            };

            const causes = useMemo(() => ['all', ...new Set(registry.map(r => r.cause).filter(Boolean))], [registry]);
            const locations = useMemo(() => ['all', ...new Set(registry.map(r => r.location).filter(Boolean))], [registry]);

            return (
                <div className="min-h-screen bg-slate-50 flex flex-col text-left selection:bg-blue-100">
                    <nav className="bg-white border-b border-slate-200 px-8 py-4 flex justify-between items-center sticky top-0 z-[1000]">
                        <div className="flex items-center gap-4 text-left text-blue-600">
                            <Icon name="zap" size={24} className="fill-current" />
                            <div>
                                <h2 className="text-sm font-black uppercase tracking-tighter text-slate-900 leading-none">Intelligence Hub</h2>
                                <p className="text-[10px] font-bold text-slate-400 uppercase tracking-widest mt-1 italic leading-none text-left">V21.21 FORENSIC TRACE</p>
                            </div>
                        </div>
                        <div className="flex items-center gap-4">
                            <button onClick={() => setIsAdmin(!isAdmin)} className={'px-4 py-2 rounded-2xl text-[10px] font-black uppercase tracking-widest transition-all flex items-center gap-2 border ' + (isAdmin ? 'bg-slate-900 text-white border-slate-900 shadow-xl' : 'bg-blue-50 text-blue-600 border-blue-200 shadow-sm')}>{isAdmin ? <Icon name="shield-check" size={14} /> : <Icon name="users" size={14} />} {isAdmin ? 'Admin Mode' : 'Colleague View'}</button>
                            {isAdmin && <button onClick={() => setActiveModal('settings')} className="text-slate-300 hover:text-slate-900 transition-colors"><Icon name="settings" size={20} /></button>}
                        </div>
                    </nav>

                    {progress.active && (
                        <div className="fixed top-[65px] left-0 w-full z-[2000] px-8">
                            <div className="max-w-[1600px] mx-auto bg-white border border-blue-100 rounded-2xl p-4 shadow-2xl overflow-hidden relative">
                                <div className="flex justify-between items-center mb-2">
                                    <span className="text-[10px] font-black text-blue-600 uppercase tracking-widest flex items-center gap-2">
                                        <Icon name="loader-2" className="w-3 h-3 animate-spin" /> {progress.status}
                                    </span>
                                    <span className="text-sm font-black text-slate-900 italic">{progress.percent}%</span>
                                </div>
                                <div className="w-full bg-slate-100 h-2 rounded-full overflow-hidden">
                                    <div className="h-full bg-blue-600 progress-shimmer transition-all duration-500" style={{ width: progress.percent + '%' }}></div>
                                </div>
                            </div>
                        </div>
                    )}

                    <main className="max-w-[1600px] mx-auto w-full p-8 flex-1">
                        {/* Stats Dashboard */}
                        <div className="grid grid-cols-1 md:grid-cols-4 gap-4 mb-8 text-center">
                            <div className="bg-white p-6 rounded-[2.5rem] border border-slate-200 shadow-sm text-center">
                                <span className="text-[10px] font-black text-slate-400 uppercase tracking-widest block mb-1">Entity Registry</span>
                                <div className="text-4xl font-black text-slate-900 leading-none">{stats.registry}</div>
                            </div>
                            <button onClick={() => setActiveModal('gap')} className="bg-white p-6 rounded-[2.5rem] border border-emerald-100 shadow-sm hover:bg-emerald-50 transition-all text-center group">
                                <span className="text-[10px] font-black text-emerald-500 uppercase tracking-widest block mb-1 underline decoration-emerald-200 italic leading-none">Strategic Risks</span>
                                <div className="text-4xl font-black text-emerald-600 leading-none mt-1">{stats.gaps}</div>
                            </button>
                            <button onClick={() => setActiveModal('permanent')} className="bg-white p-6 rounded-[2.5rem] border border-red-100 shadow-sm hover:bg-red-50 transition-all text-center group">
                                <span className="text-[10px] font-black text-red-500 uppercase tracking-widest block mb-1 underline decoration-red-200 italic leading-none">Perm Leads</span>
                                <div className="text-4xl font-black text-red-600 leading-none mt-1">{stats.leads}</div>
                            </button>
                            <button onClick={() => setActiveModal('consultancy')} className="bg-white p-6 rounded-[2.5rem] border border-purple-100 shadow-sm hover:bg-purple-50 transition-all text-center group">
                                <span className="text-[10px] font-black text-purple-500 uppercase tracking-widest block mb-1 underline decoration-purple-200 italic leading-none">Interim/Contract</span>
                                <div className="text-4xl font-black text-purple-600 leading-none mt-1">{stats.consult}</div>
                            </button>
                        </div>

                        {/* Search and Action Bar */}
                        <div className="bg-white rounded-[3rem] shadow-2xl border border-slate-200 overflow-hidden mb-8 text-left">
                            <div className="p-8 border-b border-slate-100 flex flex-col md:flex-row md:items-center justify-between gap-6 bg-slate-50/30 text-left">
                                <div className="flex-1 max-w-md relative text-left">
                                    <Icon name="search" size={18} className="absolute left-6 top-1/2 -translate-y-1/2 text-slate-300" />
                                    <input 
                                        type="text" 
                                        value={searchQuery}
                                        onChange={(e) => setSearchQuery(e.target.value)}
                                        placeholder="Search Entities, Risks, or Connections..." 
                                        className="w-full bg-white px-14 py-4 rounded-2xl border border-slate-200 outline-none text-sm font-medium focus:ring-4 ring-blue-50 transition-all shadow-sm" 
                                    />
                                </div>
                                {isAdmin && (<div className="flex items-center gap-3">
                                    <label className="cursor-pointer bg-slate-900 text-white px-6 py-4 rounded-2xl text-[11px] font-black uppercase tracking-widest hover:bg-slate-800 transition-all shadow-xl flex items-center gap-2">
                                        <Icon name="download" size={14} /> Import Data 1-7<input type="file" className="hidden" multiple accept=".csv" onChange={handleImport} />
                                    </label>
                                    <button className="bg-emerald-600 text-white px-8 py-4 rounded-2xl text-[11px] font-black uppercase tracking-widest hover:bg-emerald-700 flex items-center gap-2 shadow-lg active:scale-95 transition-all" onClick={startBatchSweep}>
                                        <Icon name="zap" size={14} /> Auto-Pilot Cycle (500/10)
                                    </button>
                                    <button onClick={bulkExportIntel} className="bg-white border border-slate-200 px-6 py-4 rounded-2xl text-[11px] font-black uppercase text-blue-600 hover:bg-blue-50 transition-all shadow-sm flex items-center gap-2">
                                        <Icon name="file-text" size={14} /> Export Audit
                                    </button>
                                    <button onClick={resetMemory} className="text-[10px] font-black uppercase text-red-400 hover:text-red-600 ml-4 flex items-center gap-1">
                                        <Icon name="trash-2" size={12} /> Reset Hub
                                    </button>
                                </div>)}
                            </div>

                            <div className="overflow-x-auto custom-scrollbar">
                                <table className="w-full text-left">
                                    <thead><tr className="bg-white border-b border-slate-100 text-left"><th className="px-10 py-6 text-[10px] font-black text-slate-400 uppercase tracking-widest w-1/4 text-left">Entity Details</th><th className="px-10 py-6 text-[10px] font-black text-slate-400 uppercase tracking-widest text-left">SIGNAL INTELLIGENCE</th><th className="px-10 py-6 text-[10px] font-black text-slate-400 uppercase tracking-widest text-right px-10">Warm Path</th></tr></thead>
                                    <tbody className="divide-y divide-slate-50 text-left">
                                        {filteredList.slice(0, 50).map((c, i) => {
                                            const jobs = (intel || []).filter(j => j && cleanName(j.charityName) === cleanName(c.name))[0]?.jobs || [];
                                            const actionId = (c.name ? String(c.name).replace(/[^a-zA-Z0-9]/g, '-') : 'row-' + i);
                                            const action = teamActions[actionId];
                                            const intro = (connections || []).find(conn => cleanName(conn.company) === cleanName(c.name));
                                            return (
                                                <tr key={i} className={'hover:bg-slate-50/50 transition-all text-left ' + (action ? 'opacity-60 grayscale bg-slate-50' : '')}>
                                                    <td className="px-10 py-10 text-left">
                                                        <div className="font-black uppercase text-xl tracking-tighter text-slate-900 leading-none">{c.name}</div>
                                                        <div className="flex flex-wrap gap-2 mt-3 text-left">
                                                            <span className={'urgency-badge border ' + (c.loxo === 'Client' ? 'bg-blue-100 text-blue-600 border-blue-200' : 'bg-white text-slate-400 border-slate-200')}>{c.loxo || 'Target'}</span>
                                                            {c.lastDeepAudit && <span className="urgency-badge bg-slate-100 text-slate-500 border-slate-200 tracking-tighter italic">Last Audit: {new Date(c.lastDeepAudit).toLocaleDateString()}</span>}
                                                            {action && <span className="urgency-badge bg-emerald-100 text-emerald-700 border-emerald-200 italic uppercase tracking-tighter text-left">Claimed: {action.owner}</span>}
                                                        </div>
                                                    </td>
                                                    <td className="px-10 py-10 text-left">
                                                        <div className="flex flex-col gap-3 text-left">
                                                            {jobs.map((j, idx) => (
                                                                <div key={idx} className={'p-5 rounded-3xl shadow-sm border border-slate-100 relative overflow-hidden text-left ' + (j.type === 'consultancy' ? 'consultancy-card' : (j.type === 'gap' ? 'gap-card' : 'bg-white'))}>
                                                                    <span className={'absolute top-0 right-0 px-3 py-1 rounded-bl font-black text-[8px] uppercase ' + (getGradeStyle(j.grade))}>Grade {j.grade || 'C'}</span>
                                                                    <div className="text-xs font-black uppercase text-slate-900 pr-14 tracking-tight leading-none mb-2 text-left">{j.title}</div>
                                                                    <div className="text-[9px] font-medium text-slate-500 mb-2 italic text-left">Signal: {j.gapType || 'Forensic Insight'} • {j.behaviorFlag}</div>
                                                                    <div className="flex gap-4 text-left">
                                                                        <span className="text-[7px] font-black text-slate-400 uppercase border-r border-slate-100 pr-3 flex items-center gap-1"><Icon name="user" size={10} /> {j.reportsTo || j.ceoFallback || 'N/A'}</span>
                                                                        <div className="flex gap-2">
                                                                            <span className="text-[7px] font-black text-slate-500 uppercase tracking-tighter text-left">Ad: {j.adDate || '??'}</span>
                                                                            <span className="text-[7px] font-black text-red-500 uppercase tracking-tighter text-left font-bold italic">End: {j.closingDate || '??'}</span>
                                                                        </div>
                                                                    </div>
                                                                </div>
                                                            ))}
                                                            {jobs.length === 0 && <div className="text-[9px] text-slate-300 italic uppercase font-bold flex items-center gap-2"><Icon name="briefcase" size={12} /> Pending systematic audit cycle</div>}
                                                        </div>
                                                    </td>
                                                    <td className="px-10 py-10 text-right">
                                                        {intro ? (
                                                            <div className="bg-blue-50 border border-blue-100 p-5 rounded-[2rem] inline-block text-left shadow-inner group hover:bg-blue-100 transition-all cursor-pointer text-left">
                                                                <div className="text-[8px] font-black text-blue-400 uppercase tracking-widest mb-1 italic flex items-center gap-1"><Icon name="link-2" size={10} /> Network contact</div>
                                                                <div className="text-[11px] font-black text-blue-900 uppercase tracking-tighter leading-none">{intro['first name']} {intro['last name']}</div>
                                                                <div className="text-[9px] font-bold text-blue-600 italic leading-none mt-1 tracking-tight">{intro.position || intro.title}</div>
                                                            </div>
                                                        ) : (
                                                            <div className="flex flex-col items-end gap-3 text-right">
                                                                <select onChange={(e) => claim(c.name, e.target.value)} className="text-[11px] font-black border-2 border-slate-200 px-5 py-3 rounded-2xl bg-white outline-none focus:border-blue-600 transition-all uppercase tracking-tighter text-right cursor-pointer">
                                                                    <option>Claim As...</option><option>Tim</option><option>Rory</option><option>Anton</option>
                                                                </select>
                                                                <button onClick={() => runGrounding(c.name, 'deep')} className="text-[9px] font-black text-slate-400 uppercase tracking-widest hover:text-blue-600 transition-all flex items-center justify-end gap-2 px-2 text-left">Deep Investigate <Icon name="chevron-right" size={12} /></button>
                                                            </div>
                                                        )}
                                                    </td>
                                                </tr>
                                            );
                                        })}
                                    </tbody>
                                </table>
                            </div>
                        </div>

                        {/* LIVE MONITOR CONSOLE */}
                        {isAdmin && (
                            <div className="grid grid-cols-1 lg:grid-cols-2 gap-8 mb-20">
                                {/* Trace Terminal */}
                                <div className="bg-slate-900 rounded-[2.5rem] p-8 text-blue-400 font-mono text-[10px] leading-relaxed shadow-2xl border border-white/5 h-[300px] flex flex-col">
                                    <div className="flex justify-between items-center mb-6 border-b border-slate-800 pb-4">
                                        <span className="uppercase tracking-widest font-black flex items-center gap-2 italic"><Icon name="terminal" size={14} /> Live Intelligence Trace</span>
                                        <span className="bg-blue-500/10 text-blue-400 px-3 py-1 rounded-full text-[8px] font-black uppercase animate-pulse">Monitoring Grounding Tools</span>
                                    </div>
                                    <div className="flex-1 overflow-y-auto custom-scrollbar space-y-1">
                                        {trace.map((t, i) => <div key={i} className="trace-line">{t}</div>)}
                                        {trace.length === 0 && <div className="text-slate-600 italic">Sweep idle. Waiting for Auto-Pilot activation...</div>}
                                    </div>
                                </div>
                                
                                {/* System Log */}
                                <div className="bg-slate-900 rounded-[2.5rem] p-8 text-slate-500 font-mono text-[10px] leading-relaxed shadow-2xl border border-white/5 h-[300px] flex flex-col">
                                    <div className="flex justify-between items-center mb-6 border-b border-slate-800 pb-4">
                                        <span className="uppercase tracking-widest font-black flex items-center gap-2 italic"><Icon name="shield-check" size={14} /> Mission Control Monitor</span>
                                        <span className="bg-emerald-500/10 text-emerald-400 px-3 py-1 rounded-full text-[8px] font-black uppercase">Core System Operational</span>
                                    </div>
                                    <div className="flex-1 overflow-y-auto custom-scrollbar space-y-1">
                                        {logs.map((l, i) => <div key={i} className="hover:text-slate-300 transition-colors">{l}</div>)}
                                    </div>
                                </div>
                            </div>
                        )}
                    </main>

                    {/* Modal Desks */}
                    {activeModal && activeModal !== 'settings' && (
                        <div className="fixed inset-0 bg-slate-900/90 backdrop-blur-md z-[5000] p-4 md:p-10 flex items-center justify-center text-left">
                            <div className="bg-white rounded-[4rem] shadow-2xl w-full h-full max-w-[1600px] flex flex-col overflow-hidden relative border border-white/20 text-left">
                                <button onClick={() => setActiveModal(null)} className="absolute top-8 right-8 p-4 bg-slate-100 rounded-full hover:bg-slate-200 transition-all z-[10] shadow-sm"><Icon name="x" size={20} className="text-slate-900" /></button>
                                <div className="p-10 border-b border-slate-100 bg-slate-50/50 text-left">
                                    <div className="flex justify-between items-end text-left">
                                        <div>
                                            <h2 className="text-4xl font-black italic uppercase tracking-tighter text-slate-900 leading-none text-left">
                                                {activeModal === 'gap' ? 'Proactive Risk Desk' : activeModal === 'consultancy' ? 'Interim & Per-Day Desk' : 'Active search Intel'}
                                            </h2>
                                            <p className="text-xs font-bold text-slate-400 uppercase tracking-widest mt-2 text-left italic leading-none">Strategic Benchmarking Data for Tim & Rory</p>
                                        </div>
                                        <div className="flex gap-4">
                                            <div className="flex flex-col gap-1 text-left">
                                                <label className="text-[8px] font-black text-slate-400 uppercase ml-1">Cause Area</label>
                                                <select value={leadFilters.cause} onChange={(e) => setLeadFilters({...leadFilters, cause: e.target.value})} className="bg-slate-100 border-none rounded-xl text-[10px] font-black px-4 py-2 uppercase outline-none shadow-inner">
                                                    {causes.map(c => <option key={c} value={c}>{c}</option>)}
                                                </select>
                                            </div>
                                            <div className="flex flex-col gap-1 text-left">
                                                <label className="text-[8px] font-black text-slate-400 uppercase ml-1">HQ Region</label>
                                                <select value={leadFilters.location} onChange={(e) => setLeadFilters({...leadFilters, location: e.target.value})} className="bg-slate-100 border-none rounded-xl text-[10px] font-black px-4 py-2 uppercase outline-none shadow-inner text-left">
                                                    {locations.map(l => <option key={l} value={l}>{l}</option>)}
                                                </select>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <div className="flex-1 overflow-auto custom-scrollbar p-10 text-left">
                                    <DeskTable items={deskItems} teamActions={teamActions} onClaim={claim} />
                                </div>
                            </div>
                        </div>
                    )}

                    {activeModal === 'settings' && (
                        <div className="fixed inset-0 bg-slate-900/95 backdrop-blur-xl z-[6000] flex items-center justify-center p-6 text-center text-left">
                            <div className="bg-white rounded-[3.5rem] shadow-2xl max-w-md w-full p-12 text-left">
                                <h3 className="text-3xl font-black text-slate-900 mb-2 uppercase tracking-tighter italic text-center leading-none text-left text-blue-600">Security Core</h3>
                                <div className="space-y-6 mt-8 text-left text-[10px]">
                                    <div><label className="block text-[9px] font-black uppercase text-slate-400 mb-2 tracking-widest ml-1 text-left text-left text-left">Gemini API Pro</label><input type="password" id="gemini-key-input" defaultValue={keys.gemini} className="w-full bg-slate-50 px-6 py-5 rounded-2xl border outline-none font-mono text-xs focus:ring-4 ring-blue-50 transition-all text-left" /></div>
                                    <div><label className="block text-[9px] font-black uppercase text-slate-400 mb-2 tracking-widest ml-1 text-left text-left text-left">Loxo API Key</label><input type="password" id="loxo-key-input" defaultValue={keys.loxo} className="w-full bg-slate-50 px-6 py-5 rounded-2xl border outline-none font-mono text-xs focus:ring-4 ring-blue-50 transition-all text-left" /></div>
                                    <div><label className="block text-[9px] font-black uppercase text-slate-400 mb-2 tracking-widest ml-1 text-left text-left text-left">CC-API Sub Key</label><input type="password" id="cc-key-input" defaultValue={keys.cc} className="w-full bg-slate-50 px-6 py-5 rounded-2xl border outline-none font-mono text-xs focus:ring-4 ring-blue-50 transition-all text-left" /></div>
                                </div>
                                <button onClick={() => { 
                                    const g = document.getElementById('gemini-key-input').value;
                                    const l = document.getElementById('loxo-key-input').value;
                                    const c = document.getElementById('cc-key-input').value;
                                    localStorage.setItem('hub_gemini_key', g); 
                                    localStorage.setItem('hub_loxo_key', l); 
                                    localStorage.setItem('hub_cc_key', c); 
                                    setKeys({ gemini: g, loxo: l, cc: c });
                                    setActiveModal(null); 
                                    addLog('Security credentials synchronized.'); 
                                }} className="w-full bg-blue-600 text-white py-6 rounded-2xl font-black uppercase italic shadow-2xl mt-10 hover:bg-blue-700 transition-all active:scale-95 text-center">Verify deployment</button>
                            </div>
                        </div>
                    )}
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        if (root) root.render(<App />);
    </script>
</body>
</html>
