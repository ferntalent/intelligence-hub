<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Intelligence Hub V21.12 - Auto-Pilot</title>
    <!-- LIBS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&display=swap');
        body { font-family: 'Inter', sans-serif; background-color: #f8fafc; color: #0f172a; text-align: left; }
        .custom-scrollbar::-webkit-scrollbar { width: 5px; height: 5px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: #f1f5f9; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 10px; }
        .urgency-badge { padding: 2px 8px; border-radius: 9999px; font-size: 10px; font-weight: 900; text-transform: uppercase; border: 1px solid transparent; }
        .grade-a { background-color: #ef4444; color: white; border-color: #fee2e2; }
        .grade-b { background-color: #f97316; color: white; }
        .grade-c { background-color: #3b82f6; color: white; }
        .consultancy-card { border-left: 4px solid #8b5cf6; background-color: #f5f3ff; }
        .gap-card { border-left: 4px solid #10b981; background-color: #f0fdf4; }
        .progress-shimmer { background: linear-gradient(90deg, rgba(255,255,255,0) 0%, rgba(255,255,255,0.4) 50%, rgba(255,255,255,0) 100%); background-size: 200% 100%; animation: shimmer 1.5s infinite; }
        @keyframes shimmer { 0% { background-position: 200% 0; } 100% { background-position: -200% 0; } }
    </style>
</head>
<body class="p-4 md:p-8">
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useMemo, useCallback } = React;

        const Icon = ({ name, size = 16, className = "" }) => {
            useEffect(() => {
                if (window.lucide) window.lucide.createIcons();
            }, [name]);
            return <i data-lucide={name} className={className} style={{ width: size, height: size, display: 'inline-flex', alignItems: 'center', justifyContent: 'center' }}></i>;
        };

        const API_BASE = "https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent";

        // --- STABILITY UTILS ---
        const safeJsonLoad = (key, fallback) => {
            try {
                if (typeof window === 'undefined') return fallback;
                const item = localStorage.getItem(key);
                if (!item) return fallback;
                const parsed = JSON.parse(item);
                if (Array.isArray(fallback) && !Array.isArray(parsed)) return fallback;
                return parsed;
            } catch (e) { return fallback; }
        };

        const cleanName = (n) => n ? n.toLowerCase().split('(')[0].replace(/limited|ltd|trust|uk|the|group|charity|foundation|school/gi, '').replace(/[^a-z0-9]/g, '').trim() : '';

        const splitLine = (str) => {
            const res = []; let cell = ''; let inQ = false;
            if (!str) return res;
            for (let i = 0; i < str.length; i++) {
                const char = str[i];
                if (char === '"') inQ = !inQ;
                else if (char === ',' && !inQ) { res.push(cell.trim()); cell = ''; }
                else if (char !== '\r') cell += char;
            }
            res.push(cell.trim()); return res;
        };

        const getGradeStyle = (grade) => {
            const g = (grade || 'C').toUpperCase();
            if (g.startsWith('A')) return 'grade-a';
            if (g === 'B') return 'grade-b';
            return 'grade-c';
        };

        // --- SUB-COMPONENTS ---
        const DeskTable = ({ items, teamActions, onClaim }) => (
            <table className="w-full text-left border-collapse">
                <thead>
                    <tr className="border-b border-slate-200">
                        <th className="py-4 text-[10px] font-black uppercase text-slate-400 px-2">Entity</th>
                        <th className="py-4 text-[10px] font-black uppercase text-slate-400 px-2">Role & Temporal Signal</th>
                        <th className="py-4 text-[10px] font-black uppercase text-slate-400 text-center">Grade</th>
                        <th className="py-4 text-[10px] font-black uppercase text-slate-400 px-2 w-[40%]">Strategic Narrative</th>
                        <th className="py-4 text-[10px] font-black uppercase text-slate-400 text-right px-2">Action</th>
                    </tr>
                </thead>
                <tbody className="divide-y divide-slate-100">
                    {(items || []).map((l, i) => {
                        const actionId = l.charity ? l.charity.replace(/[^a-zA-Z0-9]/g, '-') : 'row-' + i;
                        const action = (teamActions || {})[actionId];
                        return (
                            <tr key={i} className={action ? 'opacity-40 grayscale' : ''}>
                                <td className="py-6 px-2 font-black uppercase text-[11px] text-slate-900 leading-tight">
                                    {l.charity}
                                    <div className="text-[7px] text-slate-400 font-bold mt-1 uppercase italic">Audit: {l.auditDate || 'New'}</div>
                                </td>
                                <td className="py-6 px-2">
                                    <div className="font-bold text-[11px] text-blue-600 uppercase italic leading-none">{l.title}</div>
                                    <div className="text-[8px] font-bold text-slate-400 mt-2 uppercase">Lead: {l.reportsTo || 'N/A'}</div>
                                    <div className="flex gap-2 mt-2">
                                        <span className="text-[7px] bg-slate-100 px-1.5 py-0.5 rounded text-slate-500 font-black uppercase">AD: {l.adDate || '??'}</span>
                                        <span className="text-[7px] bg-red-50 px-1.5 py-0.5 rounded text-red-500 font-black uppercase">CLOSE: {l.closingDate || '??'}</span>
                                    </div>
                                </td>
                                <td className="py-6 text-center">
                                    <span className={'urgency-badge ' + getGradeStyle(l.grade)}>{l.grade === 'A' ? 'CRITICAL' : l.grade === 'B' ? 'STRATEGIC' : 'MONITOR'}</span>
                                </td>
                                <td className="py-6 px-2 text-[10px] font-medium leading-relaxed italic text-slate-500 border-l border-slate-50 pl-6 text-left">
                                    <div className="font-bold text-slate-800 not-italic mb-1 uppercase text-[8px] tracking-widest">{l.gapType || 'Recruitment Insight'}</div>
                                    {l.behaviorFlag}
                                    <div className="mt-2 text-[8px] font-black text-blue-500 uppercase tracking-widest leading-none">Source: {l.source || 'Discovery'}</div>
                                </td>
                                <td className="py-6 px-2 text-right">
                                    <div className="flex items-center justify-end gap-2 text-right">
                                        <a href={l.link} target="_blank" rel="noopener noreferrer" className="p-3 bg-slate-100 rounded-2xl hover:bg-slate-200">
                                            <Icon name="external-link" size={16} className="text-slate-400" />
                                        </a>
                                        {action ? (
                                            <span className="text-[8px] font-black text-emerald-600 uppercase italic px-4">Synced</span>
                                        ) : (
                                            <button onClick={() => onClaim(l.charity, 'Tim')} className="bg-blue-600 text-white text-[9px] font-black px-4 py-2 rounded-xl uppercase shadow-md hover:bg-blue-700">Sync</button>
                                        )}
                                    </div>
                                </td>
                            </tr>
                        );
                    })}
                </tbody>
            </table>
        );

        // --- MAIN APP ---
        function App() {
            const [registry, setRegistry] = useState(() => safeJsonLoad('hub_registry', []));
            const [intel, setIntel] = useState(() => safeJsonLoad('hub_intel', []));
            const [teamActions, setTeamActions] = useState(() => safeJsonLoad('hub_actions', {}));
            const [connections, setConnections] = useState(() => safeJsonLoad('hub_connections', []));
            const [schools, setSchools] = useState(() => safeJsonLoad('hub_schools', []));

            const [isAdmin, setIsAdmin] = useState(true);
            const [activeModal, setActiveModal] = useState(null); 
            const [searchQuery, setSearchQuery] = useState('');
            const [logs, setLogs] = useState(['[SYSTEM] V21.12 Auto-Pilot online.']);
            const [progress, setProgress] = useState({ active: false, percent: 0, status: '' });
            const [emailInput, setEmailInput] = useState('');
            
            const [keys, setKeys] = useState(() => ({
                gemini: (typeof window !== 'undefined' ? localStorage.getItem('hub_gemini_key') : '') || '',
                loxo: (typeof window !== 'undefined' ? localStorage.getItem('hub_loxo_key') : '') || '',
                cc: (typeof window !== 'undefined' ? localStorage.getItem('hub_cc_key') : '') || ''
            }));

            const addLog = useCallback((m) => setLogs(p => ['[' + new Date().toLocaleTimeString() + '] ' + m, ...p].slice(0, 30)), []);

            const resetMemory = () => {
                if (window.confirm("Confirm: Wipe all memory?")) {
                    localStorage.clear();
                    window.location.reload();
                }
            };

            const handleImport = (e) => {
                const files = Array.from(e.target.files);
                if (files.length === 0) return;
                setProgress({ active: true, percent: 5, status: 'Initializing async parser...' });
                
                let currentFileIndex = 0;
                const processNextFile = () => {
                    if (currentFileIndex >= files.length) {
                        setProgress({ active: true, percent: 100, status: 'Registry Map Ready.' });
                        setTimeout(() => setProgress({ active: false, percent: 0, status: '' }), 1500);
                        return;
                    }

                    const file = files[currentFileIndex];
                    const reader = new FileReader();
                    reader.onload = (event) => {
                        try {
                            const text = event.target.result;
                            const lines = text.split(/\n/).filter(l => l.trim());
                            if (lines.length < 1) { currentFileIndex++; processNextFile(); return; }
                            
                            const headers = splitLine(lines[0].toLowerCase());
                            const data = lines.slice(1).map(l => {
                                const vals = splitLine(l);
                                let obj = {};
                                headers.forEach((h, i) => obj[h.replace(/"/g, '').trim()] = (vals[i] || '').replace(/^"|"$/g, ''));
                                return obj;
                            });

                            const s = data[0] || {};
                            if (s['first name'] && s['company']) {
                                setConnections(data); localStorage.setItem('hub_connections', JSON.stringify(data));
                            } else if (s['establishmentname'] || s['headfirstname']) {
                                setSchools(data); localStorage.setItem('hub_schools', JSON.stringify(data));
                            } else if (s['agencyscore'] || s['detailedreason']) {
                                const historical = data.map(r => ({
                                    charityName: r['charity'] || r['organisation'],
                                    jobs: [{
                                        title: r['jobtitle'] || r['job title'] || 'History Lead',
                                        salary: r['salary'] || 'TBC',
                                        link: (r['link'] || r['url'] || '#').replace('https://www.google.com/search?q=', ''),
                                        since: r['tenuresince'] || 'History',
                                        reportsTo: r['reportsto'] || 'CEO',
                                        grade: r['agencyscore'] ? 'A' : 'B',
                                        type: (r['salary'] || '').toLowerCase().includes('day') ? 'consultancy' : 'permanent',
                                        behaviorFlag: r['detailedreason'] || r['reason'] || 'Archive artifact.',
                                        source: 'History'
                                    }]
                                }));
                                setIntel(prev => [...historical, ...prev]);
                            } else {
                                const isLeads = (s['job title'] || s['title']);
                                if (isLeads) {
                                    const active = data.map(r => ({
                                        charityName: r['organisation'] || r['charity'],
                                        jobs: [{
                                            title: r['job title'] || r['title'], salary: r['salary'] || 'TBC',
                                            link: (r['link'] || r['url'] || '#').replace('https://www.google.com/search?q=', ''),
                                            since: r['advertised since'] || 'Recently',
                                            reportsTo: r['reports to'] || 'CEO', grade: 'C',
                                            type: (r['salary'] || '').toLowerCase().includes('day') ? 'consultancy' : 'permanent',
                                            behaviorFlag: r['note'] || 'Discovery artifact.', source: 'Import'
                                        }]
                                    }));
                                    setIntel(prev => [...active, ...prev]);
                                } else {
                                    const newReg = [...registry];
                                    data.forEach(r => {
                                        const n = r['charity name'] || r['organisation'] || r['name'];
                                        if (!n) return;
                                        const idx = newReg.findIndex(m => cleanName(m.name) === cleanName(n));
                                        if (idx > -1) {
                                            newReg[idx].loxo = (r['loxo status'] === 'Client' ? 'Client' : newReg[idx].loxo);
                                        } else {
                                            newReg.push({ name: n, id: r['charity number'], loxo: (r['loxo status'] || 'Target'), lastGeneralSweep: null, lastDeepAudit: null });
                                        }
                                    });
                                    setRegistry(newReg); localStorage.setItem('hub_registry', JSON.stringify(newReg));
                                }
                            }
                            currentFileIndex++;
                            setProgress({ active: true, percent: Math.round((currentFileIndex / files.length) * 100), status: 'Syncing Layer ' + file.name });
                            setTimeout(processNextFile, 100);
                        } catch (err) { currentFileIndex++; processNextFile(); }
                    };
                    reader.readAsText(file);
                };
                processNextFile();
            };

            const stats = useMemo(() => {
                const list = (intel || []).flatMap(i => (i && Array.isArray(i.jobs)) ? i.jobs : []);
                return {
                    registry: (registry || []).length,
                    leads: list.filter(j => j.type === 'permanent').length,
                    consult: list.filter(j => j.type === 'consultancy').length,
                    gaps: list.filter(j => j.type === 'gap').length
                };
            }, [registry, intel]);

            const filteredList = (registry || []).filter(c => c.name?.toLowerCase().includes(searchQuery.toLowerCase()));

            const deskItems = useMemo(() => {
                if (!activeModal || activeModal === 'settings') return [];
                const items = [];
                (intel || []).forEach(e => (e?.jobs || []).forEach(j => { if (j.type === activeModal) items.push({ charity: e.charityName, auditDate: e.foundAt, ...j }); }));
                return items;
            }, [activeModal, intel]);

            const claim = (n, u) => {
                const id = n.replace(/[^a-zA-Z0-9]/g, '-');
                const upd = { ...teamActions, [id]: { owner: u, date: new Date().toISOString() } };
                setTeamActions(upd); localStorage.setItem('hub_actions', JSON.stringify(upd));
                addLog(u + ' claimed: ' + n);
            };

            const runGrounding = async (name, mode = 'deep') => {
                if (!keys.gemini) { setActiveModal('settings'); return; }
                const promptDeep = "Investigate UK Charity " + name + ". REQUIREMENTS: " +
                                   "1. VACANCIES: CharityJob, Guardian, Bond, ThirdSector. Extract Permanent vs Consultancy. " +
                                   "2. DATES: Find 'Ad Post Date' and 'Application Closing Date'. " +
                                   "3. GAPS: Audit Charity Commission. Legacy <5% vs IG total? Statutory reliance >70%? Financial Decline? " +
                                   "4. RISK: Section 114, decommissioning, MTFS cuts, toxic culture, DMARC fail. " +
                                   "Return JSON ONLY: {\"jobs\": [{\"title\": \"Lead\", \"adDate\": \"DD/MM\", \"closingDate\": \"DD/MM\", \"link\": \"url\", \"grade\": \"A|B|C\", \"type\": \"permanent|consultancy|gap\", \"gapType\": \"Risk Category\", \"behaviorFlag\": \"Strategic narrative\", \"reportsTo\": \"Mgr\"}]}";

                const promptPulse = "Identify if " + name + " has ANY active fundraising vacancies live online today. Just return 'YES' + JSON with titles and links if active. JSON ONLY: {\"active\": boolean, \"jobs\": []}";

                const prompt = mode === 'deep' ? promptDeep : promptPulse;

                try {
                    const res = await fetch(API_BASE + "?key=" + keys.gemini, {
                        method: "POST",
                        headers: { "Content-Type": "application/json" },
                        body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }], tools: mode === 'deep' ? [{ "google_search": {} }] : [] })
                    });
                    const data = await res.json();
                    const rawText = data?.candidates?.[0]?.content?.parts?.[0]?.text || "{\"jobs\": []}";
                    const parsed = JSON.parse(rawText.replace(/```json/g, '').replace(/```/g, '').trim());
                    
                    if (parsed.jobs && parsed.jobs.length > 0) {
                        const updated = [{ charityName: name, foundAt: new Date().toLocaleDateString(), jobs: parsed.jobs }, ...intel];
                        setIntel(updated);
                        localStorage.setItem('hub_intel', JSON.stringify(updated));
                        addLog((mode === 'deep' ? 'Forensic Audit' : 'Pulse Scan') + ' Secured: ' + name);
                    }

                    // Update Registry Timestamps
                    setRegistry(prev => {
                        const next = prev.map(c => c.name === name ? { ...c, [mode === 'deep' ? 'lastDeepAudit' : 'lastGeneralSweep']: new Date().toLocaleDateString() } : c);
                        localStorage.setItem('hub_registry', JSON.stringify(next));
                        return next;
                    });
                } catch (err) { addLog('Logic stall for ' + name); }
            };

            const startBatchSweep = async () => {
                if (!keys.gemini) { setActiveModal('settings'); return; }
                
                // 1. PHASE ONE: General Sweep (500)
                const pulseBatchSize = 500;
                const pulseTargets = [...registry]
                    .filter(c => !c.lastGeneralSweep)
                    .slice(0, pulseBatchSize);

                if (pulseTargets.length > 0) {
                    addLog('Phase 1/2: High-Volume Pulse Scan (' + pulseTargets.length + ' targets)...');
                    setProgress({ active: true, percent: 10, status: 'Scanning 500 Targets (Pulse Phase)...' });
                    // Note: In browser environment we batch them to avoid crash
                    for(let i=0; i<pulseTargets.length; i+=10) {
                       setProgress({ active: true, percent: Math.round((i/pulseTargets.length)*50), status: 'General Sweep: ' + (i+1) + '/' + pulseTargets.length });
                       await Promise.all(pulseTargets.slice(i, i+10).map(t => runGrounding(t.name, 'pulse')));
                    }
                }

                // 2. PHASE TWO: Forensic Deep Audit (10)
                const auditBatchSize = 10;
                const auditTargets = [...registry]
                    .sort((a, b) => {
                        if (!a.lastDeepAudit) return -1;
                        return new Date(a.lastDeepAudit) - new Date(b.lastDeepAudit);
                    })
                    .slice(0, auditBatchSize);

                addLog('Phase 2/2: Forensic Deep Audit (Next ' + auditTargets.length + ' targets)...');
                for (let i = 0; i < auditTargets.length; i++) {
                    const char = auditTargets[i];
                    setProgress({ active: true, percent: 50 + Math.round(((i + 1) / auditTargets.length) * 50), status: 'Deep Audit: ' + char.name });
                    await runGrounding(char.name, 'deep');
                    await new Promise(r => setTimeout(r, 2000));
                }

                addLog('Dual-Stage Sweep Complete.');
                setProgress({ active: true, percent: 100, status: 'Automation Finalized.' });
                setTimeout(() => setProgress({ active: false, percent: 0, status: '' }), 1500);
            };

            const handleEmailParse = async () => {
                if (!emailInput.trim() || !keys.gemini) return;
                setProgress({ active: true, percent: 10, status: 'Parsing Intel Feed...' });
                const prompt = "Extract leads (>£40k) from alert. Delineate Perm vs Consultancy. Find post/closing dates. JSON ONLY: {\"jobs\": [{\"title\": \"Role\", \"charity\": \"Name\", \"type\": \"permanent|consultancy\", \"link\": \"url\", \"adDate\": \"DD/MM\", \"closingDate\": \"DD/MM\"}]}. Text: " + emailInput;
                try {
                    const res = await fetch(API_BASE + "?key=" + keys.gemini, {
                        method: "POST", headers: { "Content-Type": "application/json" },
                        body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }] })
                    });
                    const data = await res.json();
                    const rawText = data?.candidates?.[0]?.content?.parts?.[0]?.text || "{\"jobs\": []}";
                    const parsed = JSON.parse(rawText.replace(/```json/g, '').replace(/```/g, '').trim());
                    if (parsed.jobs) {
                        const formatted = parsed.jobs.map(j => ({ charityName: j.charity, foundAt: new Date().toLocaleDateString(), jobs: [{ ...j, behaviorFlag: 'Email Intelligence Intake', reportsTo: 'Recruiter', grade: 'B' }] }));
                        setIntel(prev => [...formatted, ...prev]);
                        addLog('Imported ' + parsed.jobs.length + ' leads from Intel Feed.');
                    }
                    setEmailInput('');
                    setProgress({ active: false, percent: 0, status: '' });
                } catch (err) { setProgress({ active: false, percent: 0, status: '' }); }
            };

            return (
                <div className="min-h-screen bg-slate-50 flex flex-col">
                    <nav className="bg-white border-b border-slate-200 px-8 py-4 flex justify-between items-center sticky top-0 z-[1000]">
                        <div className="flex items-center gap-4 text-left text-blue-600">
                            <Icon name="zap" size={24} className="fill-current" />
                            <div>
                                <h2 className="text-sm font-black uppercase tracking-tighter text-slate-900 leading-none">Intelligence Hub</h2>
                                <p className="text-[10px] font-bold text-slate-400 uppercase tracking-widest mt-1 italic leading-none text-left">V21.12 AUTO-PILOT</p>
                            </div>
                        </div>
                        <div className="flex items-center gap-4">
                            <button onClick={() => setIsAdmin(!isAdmin)} className={'px-4 py-2 rounded-2xl text-[10px] font-black uppercase tracking-widest transition-all flex items-center gap-2 border ' + (isAdmin ? 'bg-slate-900 text-white border-slate-900' : 'bg-blue-50 text-blue-600 border-blue-200 shadow-sm')}>{isAdmin ? <Icon name="shield-check" size={14} /> : <Icon name="users" size={14} />} {isAdmin ? 'Admin Mode' : 'Colleague View'}</button>
                            {isAdmin && <button onClick={() => setActiveModal('settings')} className="text-slate-300 hover:text-slate-900 transition-colors"><Icon name="settings" size={20} /></button>}
                        </div>
                    </nav>

                    {progress.active && (
                        <div className="fixed top-[65px] left-0 w-full z-[2000] px-8">
                            <div className="max-w-[1600px] mx-auto bg-white border border-blue-100 rounded-2xl p-4 shadow-xl overflow-hidden">
                                <div className="flex justify-between items-center mb-2">
                                    <span className="text-[10px] font-black text-blue-600 uppercase tracking-widest flex items-center gap-2">
                                        <Icon name="loader-2" className="w-3 h-3 animate-spin" /> {progress.status}
                                    </span>
                                    <span className="text-sm font-black text-slate-900 italic">{progress.percent}%</span>
                                </div>
                                <div className="w-full bg-slate-100 h-2 rounded-full overflow-hidden">
                                    <div className="h-full bg-blue-600 progress-shimmer transition-all duration-500" style={{ width: progress.percent + '%' }}></div>
                                </div>
                            </div>
                        </div>
                    )}

                    <main className="max-w-[1600px] mx-auto w-full p-8 flex-1">
                        <div className="grid grid-cols-1 md:grid-cols-4 gap-4 mb-8 text-center">
                            <div className="bg-white p-6 rounded-[2.5rem] border border-slate-200 shadow-sm text-center">
                                <span className="text-[10px] font-black text-slate-400 uppercase tracking-widest block mb-1">Entity Registry</span>
                                <div className="text-4xl font-black text-slate-900 leading-none">{stats.registry}</div>
                            </div>
                            <button onClick={() => setActiveModal('gap')} className="bg-white p-6 rounded-[2.5rem] border border-emerald-100 shadow-sm hover:bg-emerald-50 transition-all text-center group">
                                <span className="text-[10px] font-black text-emerald-500 uppercase tracking-widest block mb-1">Strategic Risks</span>
                                <div className="text-4xl font-black text-emerald-600 leading-none">{stats.gaps}</div>
                            </button>
                            <button onClick={() => setActiveModal('permanent')} className="bg-white p-6 rounded-[2.5rem] border border-red-100 shadow-sm hover:bg-red-50 transition-all text-center group">
                                <span className="text-[10px] font-black text-red-500 uppercase tracking-widest block mb-1">Perm Leads</span>
                                <div className="text-4xl font-black text-red-600 leading-none">{stats.leads}</div>
                            </button>
                            <button onClick={() => setActiveModal('consultancy')} className="bg-white p-6 rounded-[2.5rem] border border-purple-100 shadow-sm hover:bg-purple-50 transition-all text-center group">
                                <span className="text-[10px] font-black text-purple-500 uppercase tracking-widest block mb-1">Interim/Contract</span>
                                <div className="text-4xl font-black text-purple-600 leading-none">{stats.consult}</div>
                            </button>
                        </div>

                        <div className="bg-white rounded-[3rem] shadow-2xl border border-slate-200 overflow-hidden mb-8 text-left">
                            <div className="p-8 border-b border-slate-100 flex flex-col md:flex-row md:items-center justify-between gap-6 bg-slate-50/30 text-left">
                                <div className="flex-1 max-w-md relative text-left">
                                    <Icon name="search" size={18} className="absolute left-6 top-1/2 -translate-y-1/2 text-slate-300" />
                                    <input type="text" value={searchQuery} onChange={(e) => setSearchQuery(e.target.value)} placeholder="Search Entity, Risk Indicator, or Contact..." className="w-full bg-white px-14 py-4 rounded-2xl border border-slate-200 outline-none text-sm font-medium focus:ring-4 ring-blue-50 transition-all" />
                                </div>
                                {isAdmin && (<div className="flex items-center gap-3">
                                    <label className="cursor-pointer bg-slate-900 text-white px-6 py-4 rounded-2xl text-[11px] font-black uppercase tracking-widest hover:bg-slate-800 transition-all shadow-xl flex items-center gap-2">
                                        <Icon name="download" size={14} /> Import Data 1-7<input type="file" className="hidden" multiple accept=".csv" onChange={handleImport} />
                                    </label>
                                    <button className="bg-emerald-600 text-white px-8 py-4 rounded-2xl text-[11px] font-black uppercase tracking-widest hover:bg-emerald-700 flex items-center gap-2 shadow-lg" onClick={startBatchSweep}>
                                        <Icon name="zap" size={14} /> Auto-Pilot Sweep (500 Pulse / 10 Deep)
                                    </button>
                                    <button onClick={resetMemory} className="text-[10px] font-black uppercase text-red-400 hover:text-red-600 ml-4 flex items-center gap-1">
                                        <Icon name="trash-2" size={12} /> Reset
                                    </button>
                                </div>)}
                            </div>
                            
                            {isAdmin && (
                                <div className="p-8 bg-blue-50/50 border-b border-slate-100">
                                    <div className="flex flex-col gap-3 text-left">
                                        <label className="text-[10px] font-black uppercase text-blue-600 tracking-widest italic flex items-center gap-2"><Icon name="mail" size={12} /> Intelligence Feed Intake</label>
                                        <div className="flex gap-4 text-left">
                                            <textarea value={emailInput} onChange={(e) => setEmailInput(e.target.value)} placeholder="Paste daily job board alerts here (Guardian, CharityJob, etc.)..." className="flex-1 p-4 rounded-xl border border-blue-100 bg-white text-xs outline-none focus:ring-4 ring-blue-50 transition-all h-20 custom-scrollbar"></textarea>
                                            <button onClick={handleEmailParse} className="bg-blue-600 text-white px-8 rounded-xl font-black uppercase text-[10px] hover:bg-blue-700 transition-all active:scale-95 shadow-lg">Parse Feed</button>
                                        </div>
                                    </div>
                                </div>
                            )}

                            <div className="overflow-x-auto custom-scrollbar">
                                <table className="w-full text-left">
                                    <thead><tr className="bg-white border-b border-slate-100"><th className="px-10 py-6 text-[10px] font-black text-slate-400 uppercase tracking-widest w-1/4">Entity Details</th><th className="px-10 py-6 text-[10px] font-black text-slate-400 uppercase tracking-widest">SIGNAL INTELLIGENCE</th><th className="px-10 py-6 text-[10px] font-black text-slate-400 uppercase tracking-widest text-right px-10">Warm Path</th></tr></thead>
                                    <tbody className="divide-y divide-slate-50 text-left">
                                        {(filteredList.slice(0, 50) || []).map((c, i) => {
                                            const jobs = (intel || []).filter(j => j && cleanName(j.charityName) === cleanName(c.name))[0]?.jobs || [];
                                            const actionId = (c.name ? c.name.replace(/[^a-zA-Z0-9]/g, '-') : 'row-' + i);
                                            const action = (teamActions || {})[actionId];
                                            const intro = (connections || []).find(conn => conn && cleanName(conn.company) === cleanName(c.name));
                                            return (
                                                <tr key={i} className={'hover:bg-slate-50/50 transition-all ' + (action ? 'opacity-60 grayscale bg-slate-50' : '')}>
                                                    <td className="px-10 py-10 text-left">
                                                        <div className="font-black uppercase text-xl tracking-tighter text-slate-900 leading-none">{c.name}</div>
                                                        <div className="flex flex-wrap gap-2 mt-3 text-left">
                                                            <span className={'urgency-badge border ' + (c.loxo === 'Client' ? 'bg-blue-100 text-blue-600 border-blue-200' : 'bg-white text-slate-400 border-slate-200')}>{c.loxo || 'Target'}</span>
                                                            {c.lastDeepAudit && <span className="urgency-badge bg-slate-100 text-slate-500 border-slate-200 tracking-tighter">Audit: {c.lastDeepAudit}</span>}
                                                            {action && <span className="urgency-badge bg-emerald-100 text-emerald-700 border-emerald-200 italic uppercase tracking-tighter">Claimed: {action.owner}</span>}
                                                        </div>
                                                    </td>
                                                    <td className="px-10 py-10 text-left">
                                                        <div className="flex flex-col gap-3 text-left">
                                                            {jobs.map((j, idx) => (
                                                                <div key={idx} className={'p-5 rounded-3xl shadow-sm border border-slate-100 relative overflow-hidden ' + (j.type === 'consultancy' ? 'consultancy-card' : (j.type === 'gap' ? 'gap-card' : 'bg-white'))}>
                                                                    <span className={'absolute top-0 right-0 px-3 py-1 rounded-bl font-black text-[8px] uppercase ' + (getGradeStyle(j.grade))}>Grade {j.grade || 'C'}</span>
                                                                    <div className="text-xs font-black uppercase text-slate-900 pr-14 tracking-tight leading-none mb-2 text-left">{j.title}</div>
                                                                    <div className="text-[9px] font-medium text-slate-500 mb-2 italic">Signal: {j.gapType || 'Active Discovery'} • {j.behaviorFlag}</div>
                                                                    <div className="flex gap-3 text-left">
                                                                        <span className="text-[7px] font-black text-slate-400 uppercase border-r border-slate-100 pr-3">Contact: {j.reportsTo || 'N/A'}</span>
                                                                        <span className="text-[7px] font-black text-slate-500 uppercase tracking-tighter">Ad: {j.adDate || '??'}</span>
                                                                        <span className="text-[7px] font-black text-red-500 uppercase tracking-tighter">End: {j.closingDate || '??'}</span>
                                                                    </div>
                                                                </div>
                                                            ))}
                                                            {jobs.length === 0 && <div className="text-[9px] text-slate-300 italic uppercase font-bold flex items-center gap-2"><Icon name="briefcase" size={12} /> Pending Auto-Pilot scan</div>}
                                                        </div>
                                                    </td>
                                                    <td className="px-10 py-10 text-right">
                                                        {intro ? (
                                                            <div className="bg-blue-50 border border-blue-100 p-5 rounded-[2rem] inline-block text-left shadow-inner group hover:bg-blue-100 transition-all cursor-pointer text-left">
                                                                <div className="text-[8px] font-black text-blue-400 uppercase tracking-widest mb-1 italic flex items-center gap-1"><Icon name="link-2" size={10} /> Network contact</div>
                                                                <div className="text-[11px] font-black text-blue-900 uppercase tracking-tighter leading-none">{intro['first name']} {intro['last name']}</div>
                                                                <div className="text-[9px] font-bold text-blue-600 italic leading-none mt-1">{intro.position || intro.title}</div>
                                                            </div>
                                                        ) : (
                                                            <div className="flex flex-col items-end gap-3 text-right">
                                                                <select onChange={(e) => claim(c.name, e.target.value)} className="text-[11px] font-black border-2 border-slate-200 px-5 py-3 rounded-2xl bg-white outline-none focus:border-blue-600 transition-all uppercase tracking-tighter text-right cursor-pointer">
                                                                    <option>Claim As...</option><option>Tim</option><option>Rory</option><option>Anton</option>
                                                                </select>
                                                                <button onClick={() => runGrounding(c.name, 'deep')} className="text-[9px] font-black text-slate-400 uppercase tracking-widest hover:text-blue-600 transition-all flex items-center justify-end gap-2 px-2">Investigate Risks <Icon name="chevron-right" size={12} /></button>
                                                            </div>
                                                        )}
                                                    </td>
                                                </tr>
                                            );
                                        })}
                                    </tbody>
                                </table>
                            </div>
                        </div>

                        {isAdmin && (
                            <div className="bg-slate-900 rounded-[2.5rem] p-8 text-slate-500 font-mono text-[10px] leading-relaxed mb-20 shadow-2xl text-left border border-white/5">
                                <div className="flex justify-between items-center mb-6 border-b border-slate-800 pb-4"><span className="text-blue-400 font-black uppercase tracking-widest italic flex items-center gap-2"><Icon name="shield-check" size={14} /> Mission Control Monitor</span><span className="text-emerald-400 font-black px-3 py-1 bg-emerald-400/10 rounded-full uppercase tracking-tighter border border-emerald-400/20 leading-none text-center text-left text-[8px]">Operational</span></div>
                                <div className="max-h-40 overflow-y-auto custom-scrollbar space-y-1 text-left">{logs.map((l, i) => <div key={i} className="hover:text-slate-300 transition-colors">{l}</div>)}</div>
                            </div>
                        )}
                    </main>

                    {/* Modal Desks */}
                    {activeModal && activeModal !== 'settings' && (
                        <div className="fixed inset-0 bg-slate-900/90 backdrop-blur-md z-[5000] p-4 md:p-10 flex items-center justify-center text-left">
                            <div className="bg-white rounded-[4rem] shadow-2xl w-full h-full max-w-[1600px] flex flex-col overflow-hidden relative border border-white/20">
                                <button onClick={() => setActiveModal(null)} className="absolute top-8 right-8 p-4 bg-slate-100 rounded-full hover:bg-slate-200 transition-all z-[10] shadow-sm"><Icon name="x" size={20} className="text-slate-900" /></button>
                                <div className="p-10 border-b border-slate-100 bg-slate-50/50 text-left"><h2 className="text-4xl font-black italic uppercase tracking-tighter text-slate-900 leading-none text-left">{activeModal === 'gap' ? 'Proactive Risk Desk' : activeModal === 'consultancy' ? 'Interim & Per-Day Desk' : 'Active search Intel'}</h2><p className="text-xs font-bold text-slate-400 uppercase tracking-widest mt-2 text-left italic">Deep temporal intelligence for agency targeting</p></div>
                                <div className="flex-1 overflow-auto custom-scrollbar p-10 text-left"><DeskTable items={deskItems} teamActions={teamActions} onClaim={claim} /></div>
                            </div>
                        </div>
                    )}

                    {activeModal === 'settings' && (
                        <div className="fixed inset-0 bg-slate-900/95 backdrop-blur-xl z-[6000] flex items-center justify-center p-6 text-center text-left">
                            <div className="bg-white rounded-[3.5rem] shadow-2xl max-w-md w-full p-12 text-left">
                                <h3 className="text-3xl font-black text-slate-900 mb-2 uppercase tracking-tighter italic text-center leading-none text-left text-blue-600">Security Core</h3>
                                <div className="space-y-6 mt-8 text-left text-[10px]">
                                    <div><label className="block text-[9px] font-black uppercase text-slate-400 mb-2 tracking-widest ml-1 text-left">Gemini API Pro</label><input type="password" id="gemini-key-input" defaultValue={keys.gemini} className="w-full bg-slate-50 px-6 py-5 rounded-2xl border outline-none font-mono text-xs focus:ring-4 ring-blue-50 transition-all" /></div>
                                    <div><label className="block text-[9px] font-black uppercase text-slate-400 mb-2 tracking-widest ml-1 text-left">Loxo API Key</label><input type="password" id="loxo-key-input" defaultValue={keys.loxo} className="w-full bg-slate-50 px-6 py-5 rounded-2xl border outline-none font-mono text-xs focus:ring-4 ring-blue-50 transition-all" /></div>
                                    <div><label className="block text-[9px] font-black uppercase text-slate-400 mb-2 tracking-widest ml-1 text-left">CC-API Sub Key</label><input type="password" id="cc-key-input" defaultValue={keys.cc} className="w-full bg-slate-50 px-6 py-5 rounded-2xl border outline-none font-mono text-xs focus:ring-4 ring-blue-50 transition-all" /></div>
                                </div>
                                <button onClick={() => { 
                                    const g = document.getElementById('gemini-key-input').value;
                                    const l = document.getElementById('loxo-key-input').value;
                                    const c = document.getElementById('cc-key-input').value;
                                    localStorage.setItem('hub_gemini_key', g); 
                                    localStorage.setItem('hub_loxo_key', l); 
                                    localStorage.setItem('hub_cc_key', c); 
                                    setKeys({ gemini: g, loxo: l, cc: c });
                                    setActiveModal(null); 
                                    addLog('Security credentials synchronized.'); 
                                }} className="w-full bg-blue-600 text-white py-6 rounded-2xl font-black uppercase italic shadow-2xl mt-10 hover:bg-blue-700 transition-all active:scale-95">Verify deployment</button>
                            </div>
                        </div>
                    )}
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
