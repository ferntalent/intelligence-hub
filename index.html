<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Intelligence Hub V18.0 - Loxo Pro</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&display=swap');
        body { font-family: 'Inter', sans-serif; background-color: #f8fafc; color: #0f172a; overflow-x: hidden; }
        .custom-scrollbar::-webkit-scrollbar { width: 5px; height: 5px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: #f1f5f9; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 10px; }
        .scanning-active { border-left: 8px solid #db2777 !important; background-color: #fff1f2 !important; transition: all 0.3s ease; }
        .urgency-badge { @apply px-2 py-0.5 rounded-full text-[7px] font-black uppercase tracking-tighter shadow-sm border; }
        .actioned-row { opacity: 0.6; background-color: #f1f5f9 !important; }
        .consultancy-card { border-left: 4px solid #8b5cf6; background-color: #f5f3ff; }
        .salaried-card { border-left: 4px solid #3b82f6; background-color: #eff6ff; }
        .failed-appt-card { border: 2px solid #ef4444; background-color: #fef2f2; }
        .shimmer-overlay { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent); animation: shimmer 2s infinite; }
        @keyframes shimmer { 0% { transform: translateX(-100%); } 100% { transform: translateX(100%); } }
        .score-pill { @apply px-2 py-1 rounded-lg text-[9px] font-black; }
    </style>
</head>
<body class="p-4 md:p-8">
    <div class="max-w-7xl mx-auto">
        <div class="flex flex-col lg:flex-row lg:items-center justify-between mb-10 gap-6">
            <div>
                <h1 class="text-4xl font-black tracking-tighter text-slate-900 flex items-center gap-3 uppercase italic leading-none">
                    Intelligence Hub
                    <span class="text-[10px] font-bold px-3 py-1 bg-blue-600 text-white rounded-full tracking-widest not-italic shadow-sm normal-case">V18.0 LOXO PRO</span>
                </h1>
                <p class="text-slate-500 mt-2 font-medium italic underline decoration-blue-200">Hierarchical Loxo Sync • Automated Line Manager Mapping • Team Action Tracker</p>
            </div>
            
            <div class="flex flex-wrap gap-3">
                <button id="settings-trigger-btn" onclick="toggleSettings()" class="bg-slate-900 text-white px-5 py-3 rounded-2xl border border-slate-800 hover:bg-slate-800 transition-all shadow-xl flex items-center gap-3">
                    <div class="text-left leading-tight">
                        <span class="block text-[10px] font-black uppercase tracking-widest text-blue-400" id="api-status-label">KEY REQUIRED</span>
                        <span class="block text-sm font-black uppercase tracking-tighter" id="user-display">System Setup</span>
                    </div>
                </button>
                <label class="cursor-pointer bg-white text-slate-700 px-6 py-3 rounded-2xl shadow-sm border border-slate-200 hover:bg-slate-50 transition-all font-bold text-sm flex items-center gap-2 uppercase tracking-tighter italic text-center">
                    Import Data
                    <input type="file" id="csv-upload" class="hidden" accept=".csv">
                </label>
                <button id="auto-pilot-btn" onclick="window.toggleAutoPilot()" class="bg-emerald-600 text-white px-8 py-3 rounded-2xl shadow-lg hover:bg-emerald-700 transition-all flex items-center gap-2 font-black uppercase tracking-tighter text-sm italic">
                    Start Strategic Sweep
                </button>
            </div>
        </div>

        <!-- Metric Grid -->
        <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6 text-center">
            <div class="bg-white p-6 rounded-3xl border border-slate-200 shadow-sm">
                <span class="text-[10px] font-black text-slate-400 uppercase tracking-widest">Master Targets</span>
                <div class="text-3xl font-black text-slate-900 mt-1" id="stat-total">0</div>
            </div>
            <div class="bg-white p-6 rounded-3xl border border-slate-200 shadow-sm text-blue-600">
                <span class="text-[10px] font-black text-slate-400 uppercase tracking-widest italic">Loxo Matched</span>
                <div class="text-3xl font-black mt-1" id="stat-clients">0</div>
            </div>
            <button onclick="toggleLeadsModal()" class="bg-white p-6 rounded-3xl border border-red-200 shadow-sm text-red-600 hover:bg-red-50 transition-all group relative overflow-hidden">
                <span class="text-[10px] font-black text-slate-400 uppercase tracking-widest underline decoration-red-200">Active Leads Desk</span>
                <div class="text-3xl font-black mt-1" id="stat-leads">0</div>
                <span class="absolute bottom-2 right-4 text-[8px] font-bold opacity-0 group-hover:opacity-100 transition-opacity italic">Sync Leads →</span>
            </button>
            <div class="bg-white p-6 rounded-3xl border border-slate-200 shadow-sm text-emerald-600">
                <span class="text-[10px] font-black text-slate-400 uppercase tracking-widest">Team Actioned</span>
                <div class="text-3xl font-black mt-1" id="stat-actioned">0</div>
            </div>
        </div>

        <!-- Progress Bar -->
        <div id="global-progress-container" class="mb-10 bg-white p-6 rounded-[2rem] border border-slate-200 shadow-sm hidden">
            <div class="flex justify-between items-end mb-3">
                <div>
                    <span id="progress-status" class="text-[10px] font-black uppercase tracking-widest text-blue-600">Syncing Intelligence...</span>
                    <div id="progress-count" class="text-[8px] font-bold text-slate-400 mt-0.5">0 of 0 processed</div>
                </div>
                <span id="progress-percent" class="text-xl font-black italic tracking-tighter text-slate-900">0%</span>
            </div>
            <div class="w-full bg-slate-100 h-4 rounded-full overflow-hidden relative">
                <div id="progress-bar-fill" class="h-full bg-blue-600 transition-all duration-300 relative" style="width: 0%">
                    <div class="shimmer-overlay"></div>
                </div>
            </div>
        </div>

        <!-- Main Workspace -->
        <div class="bg-white rounded-[2.5rem] shadow-2xl border border-slate-200 overflow-hidden mb-10 text-left">
            <div class="p-8 border-b border-slate-100 flex flex-col md:flex-row md:items-center justify-between gap-6 bg-slate-50/50">
                <input type="text" id="search-input" placeholder="Search Charity, ID, or Team Owner..." class="flex-1 max-w-md bg-white px-6 py-3 rounded-2xl border border-slate-200 outline-none text-sm font-medium shadow-sm">
                <div class="flex items-center gap-3">
                    <button onclick="window.exportHistoryCSV()" class="bg-white border border-slate-200 px-4 py-2 rounded-xl text-[10px] font-black uppercase text-blue-600 hover:bg-blue-50 transition-all shadow-sm">Export History</button>
                    <button onclick="resetSession()" class="text-[10px] font-black uppercase text-red-400 hover:text-red-600 ml-4">Reset Session</button>
                </div>
            </div>
            <div class="overflow-x-auto custom-scrollbar">
                <table class="w-full text-left border-collapse">
                    <thead>
                        <tr class="bg-white border-b border-slate-100">
                            <th class="px-10 py-6 text-[10px] font-black text-slate-400 uppercase tracking-widest w-1/4">Charity / ID / Status</th>
                            <th class="px-10 py-6 text-[10px] font-black text-slate-400 uppercase tracking-widest">Opportunity Propensity & Hierarchy</th>
                            <th class="px-10 py-6 text-[10px] font-black text-slate-400 uppercase tracking-widest text-right">Team Ownership</th>
                        </tr>
                    </thead>
                    <tbody id="table-body" class="divide-y divide-slate-50"></tbody>
                </table>
            </div>
        </div>

        <!-- System Log -->
        <div class="bg-slate-900 rounded-3xl p-6 text-slate-400 font-mono text-[10px] leading-relaxed mb-10 text-left">
            <div class="flex justify-between items-center mb-4">
                <span class="text-blue-400 font-bold uppercase tracking-widest italic">Loxo Link Monitor</span>
                <span id="scan-progress" class="text-emerald-400 font-black animate-pulse uppercase px-2 py-0.5 bg-emerald-400/10 rounded">READY</span>
            </div>
            <div id="system-log" class="max-h-32 overflow-y-auto custom-scrollbar">
                <div>[SYSTEM] V18.0 Online. Hierarchical automation ready for Loxo Sync.</div>
            </div>
        </div>
    </div>

    <!-- Leads Directory Modal -->
    <div id="leads-modal" class="fixed inset-0 bg-slate-900/90 backdrop-blur-md hidden z-[11000] p-4 md:p-10 text-left">
        <div class="bg-white rounded-[3rem] shadow-2xl h-full flex flex-col overflow-hidden">
            <div class="p-8 border-b border-slate-100 flex justify-between items-center bg-slate-50">
                <div>
                    <h2 class="text-3xl font-black italic tracking-tighter uppercase text-slate-900">Leads Desk</h2>
                    <p class="text-[10px] font-bold text-slate-400 uppercase tracking-widest text-blue-600 italic">One-Click Loxo Sync • Automatic Line Manager Verification</p>
                </div>
                <button onclick="toggleLeadsModal()" class="bg-slate-200 p-4 rounded-full hover:bg-slate-300 transition-all">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M6 18L18 6M6 6l12 12"></path></svg>
                </button>
            </div>
            <div class="flex-1 overflow-auto custom-scrollbar p-8">
                <table class="w-full text-left border-collapse">
                    <thead class="sticky top-0 bg-white z-10">
                        <tr class="border-b border-slate-200">
                            <th class="py-4 text-[10px] font-black uppercase text-slate-400">Organization</th>
                            <th class="py-4 text-[10px] font-black uppercase text-slate-400">Opportunity & Line Report</th>
                            <th class="py-4 text-[10px] font-black uppercase text-slate-400 text-center">Agency Score</th>
                            <th class="py-4 text-[10px] font-black uppercase text-slate-400">Strategic Intelligence</th>
                            <th class="py-4 text-[10px] font-black uppercase text-slate-400 text-right">Loxo Sync & Ownership</th>
                        </tr>
                    </thead>
                    <tbody id="leads-modal-body" class="divide-y divide-slate-100"></tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Settings Modal -->
    <div id="settings-modal" class="fixed inset-0 bg-slate-900/90 backdrop-blur-md hidden flex items-center justify-center p-6 z-[12000] text-center">
        <div class="bg-white rounded-[2.5rem] shadow-2xl max-w-md w-full p-10 border border-slate-100">
            <h3 class="text-2xl font-black text-slate-900 mb-2 uppercase tracking-tighter italic text-center">System Config</h3>
            <p class="text-xs text-slate-400 mb-8 font-medium italic text-center">Configure APIs for discovery and Loxo CRM sync.</p>
            <div class="space-y-6">
                <div class="text-left">
                    <label class="block text-[10px] font-black text-slate-500 uppercase mb-2 tracking-widest">Gemini API Key</label>
                    <input type="password" id="custom-api-key" placeholder="AIzaSy..." class="w-full px-5 py-4 rounded-2xl border border-slate-300 outline-none text-sm bg-slate-50 font-mono shadow-inner text-slate-900">
                </div>
                <div class="text-left">
                    <label class="block text-[10px] font-black text-slate-500 uppercase mb-2 tracking-widest">Loxo API Key</label>
                    <input type="password" id="loxo-api-key" placeholder="loxo_..." class="w-full px-5 py-4 rounded-2xl border border-slate-300 outline-none text-sm bg-slate-50 font-mono shadow-inner text-slate-900">
                </div>
            </div>
            <div class="mt-10 flex flex-col gap-3">
                <button onclick="saveSettings()" class="w-full py-4 bg-blue-600 text-white text-sm font-black rounded-2xl shadow-xl hover:bg-blue-700 transition-all uppercase italic text-center">Save Configuration</button>
                <button onclick="toggleSettings()" class="w-full py-2 text-xs font-bold text-slate-400 hover:text-slate-600 uppercase tracking-widest text-center">Close</button>
            </div>
        </div>
    </div>

    <script>
        function logToSystem(msg) { 
            const container = document.getElementById('system-log'); 
            if(container) { 
                const entry = document.createElement('div'); 
                entry.textContent = `[${new Date().toLocaleTimeString()}] ${msg}`; 
                container.prepend(entry); 
            } 
        }

        function toggleSettings() { document.getElementById('settings-modal').classList.toggle('hidden'); }
        function toggleLeadsModal() { 
            const modal = document.getElementById('leads-modal');
            modal.classList.toggle('hidden');
            if (!modal.classList.contains('hidden')) window.renderLeadsModal();
        }

        function resetSession() {
            if(confirm("Full Reset? This clears local registry memory.")) {
                localStorage.clear(); 
                location.reload();
            }
        }

        function updateProgressBar(percent, statusText, countText, isComplete = false) {
            const container = document.getElementById('global-progress-container');
            const fill = document.getElementById('progress-bar-fill');
            const percentEl = document.getElementById('progress-percent');
            const statusEl = document.getElementById('progress-status');
            const countEl = document.getElementById('progress-count');

            if (!container) return;
            container.classList.remove('hidden');
            fill.style.width = `${percent}%`;
            percentEl.textContent = `${Math.round(percent)}%`;
            statusEl.textContent = statusText;
            countEl.textContent = countText;

            if (isComplete) {
                fill.classList.replace('bg-blue-600', 'bg-emerald-500');
                statusEl.classList.replace('text-blue-600', 'text-emerald-600');
                setTimeout(() => container.classList.add('hidden'), 3000);
            }
        }
    </script>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, doc, setDoc, onSnapshot, query, addDoc, updateDoc, writeBatch } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        let masterRegistry = [], trackedIntelligence = [], teamActions = {}; 
        let activeApiKey = localStorage.getItem('intel_hub_api_key_v16_stable') || ""; 
        let loxoApiKey = localStorage.getItem('loxo_api_key_v16') || "";
        let autoPilotActive = false;

        let db = null, auth = null;
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'charity-v17-strategic-control';

        try {
            if (typeof __firebase_config !== 'undefined' && __firebase_config) {
                const config = JSON.parse(__firebase_config);
                const app = initializeApp(config);
                auth = getAuth(app);
                db = getFirestore(app);
            }
        } catch (e) { }

        window.saveSettings = () => {
            const gemini = document.getElementById('custom-api-key').value.trim();
            const loxo = document.getElementById('loxo-api-key').value.trim();
            if (gemini) { activeApiKey = gemini; localStorage.setItem('intel_hub_api_key_v16_stable', gemini); }
            if (loxo) { loxoApiKey = loxo; localStorage.setItem('loxo_api_key_v16', loxo); }
            toggleSettings();
            logToSystem("System Settings Refreshed.");
            window.renderTable();
        };

        async function init() {
            if (activeApiKey) document.getElementById('api-status-label').textContent = "LOGIC ACTIVE";
            const localReg = localStorage.getItem('local_registry');
            const localIntel = localStorage.getItem('local_intel');
            const localActions = localStorage.getItem('local_team_actions');
            if (localReg) masterRegistry = JSON.parse(localReg);
            if (localIntel) trackedIntelligence = JSON.parse(localIntel);
            if (localActions) teamActions = JSON.parse(localActions);

            if (auth) {
                try {
                    if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) await signInWithCustomToken(auth, __initial_auth_token);
                    else await signInAnonymously(auth);
                    onAuthStateChanged(auth, (u) => {
                        if (u) {
                            document.getElementById('user-display').textContent = `User: ${u.uid.substring(0, 5)}`;
                            syncSharedData();
                        }
                    });
                } catch (e) { }
            }
            window.renderTable();
            updateMetricsUI();
        }

        function syncSharedData() {
            if (!db) return;
            onSnapshot(collection(db, 'artifacts', appId, 'public', 'data', 'leads'), (snap) => {
                trackedIntelligence = snap.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                localStorage.setItem('local_intel', JSON.stringify(trackedIntelligence));
                window.renderTable();
                if (!document.getElementById('leads-modal').classList.contains('hidden')) window.renderLeadsModal();
                updateMetricsUI();
            });
            onSnapshot(collection(db, 'artifacts', appId, 'public', 'data', 'team_actions'), (snap) => {
                snap.docs.forEach(doc => { teamActions[doc.id] = doc.data(); });
                localStorage.setItem('local_team_actions', JSON.stringify(teamActions));
                window.renderTable();
                if (!document.getElementById('leads-modal').classList.contains('hidden')) window.renderLeadsModal();
                updateMetricsUI();
            });
        }

        function cleanName(name) {
            if (!name) return "";
            return name.toLowerCase().replace(/\(.*\)/g, "").replace(/limited|ltd|trust|uk|the/gi, "").replace(/[^a-z0-9]/g, "").trim();
        }

        function getScoreColor(score) {
            const s = parseInt(score);
            if (s >= 8) return 'bg-red-100 text-red-700 border border-red-200';
            if (s >= 5) return 'bg-orange-100 text-orange-700 border border-orange-200';
            return 'bg-slate-100 text-slate-500 border border-slate-200';
        }

        window.actionJob = async function(charityName, teamMember) {
            if (!teamMember || teamMember === "Select...") { alert("Select team member."); return; }
            const actionId = charityName.replace(/[^a-zA-Z0-9]/g, "-");
            const data = { actionedBy: teamMember, timestamp: new Date().toISOString() };
            teamActions[actionId] = data;
            localStorage.setItem('local_team_actions', JSON.stringify(teamActions));
            if (db) await setDoc(doc(db, 'artifacts', appId, 'public', 'data', 'team_actions', actionId), data);
            logToSystem(`${teamMember} claimed ${charityName}`);
            window.renderTable();
            window.renderLeadsModal();
            updateMetricsUI();
        };

        // ENHANCED LOXO SYNC WITH HIERARCHY CHECK
        window.syncToLoxo = async function(leadId, rowIndex) {
            if (!loxoApiKey) { logToSystem("Error: Missing Loxo Key."); toggleSettings(); return; }
            
            const lead = JSON.parse(decodeURIComponent(leadId));
            const statusEl = document.getElementById(`loxo-status-${rowIndex}`);
            if (statusEl) {
                statusEl.textContent = "Syncing...";
                statusEl.className = "text-[7px] font-black text-blue-500 animate-pulse uppercase";
            }

            logToSystem(`Verifying Loxo Hierarchy for ${lead.charity}...`);

            try {
                // STEP 1: Search Loxo for the Contact (The Line Manager)
                // In real implementation, this searches for people at the company with matching name/title
                const contactResponse = await fetch(`https://api.loxo.co/v2/contacts?company_name=${encodeURIComponent(lead.charity)}&title=${encodeURIComponent(lead.reportsTo || '')}`, {
                    headers: { 'Authorization': `Bearer ${loxoApiKey}` }
                });
                const contacts = await contactResponse.json();
                
                const matchedContact = contacts.results?.find(c => 
                    (lead.reportsToName && c.name.toLowerCase().includes(lead.reportsToName.toLowerCase())) || 
                    (lead.reportsTo && c.title.toLowerCase().includes(lead.reportsTo.toLowerCase()))
                );

                if (!matchedContact) {
                    const errorMsg = `Missing line manager - reports to ${lead.reportsTo || 'Unknown'}`;
                    logToSystem(`Sync Pause: ${errorMsg}`);
                    if (statusEl) {
                        statusEl.textContent = errorMsg;
                        statusEl.className = "text-[7px] font-black text-red-600 bg-red-50 p-1 rounded border border-red-100 uppercase";
                    }
                    return;
                }

                // STEP 2: Create the Job and Link it to the Contact
                logToSystem(`Manager found: ${matchedContact.name}. Creating job...`);
                await fetch(`https://api.loxo.co/v2/jobs`, {
                    method: 'POST',
                    headers: { 'Authorization': `Bearer ${loxoApiKey}`, 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        job: {
                            title: lead.title,
                            company_name: lead.charity,
                            hiring_manager_id: matchedContact.id,
                            description: `Strategic Intel: ${lead.behaviorFlag}. Salary: ${lead.salary}. Link: ${lead.link}`,
                            status: 'Discovery'
                        }
                    })
                });

                logToSystem(`Success: ${lead.title} linked to ${matchedContact.name} in Loxo.`);
                if (statusEl) {
                    statusEl.textContent = "Synced to Loxo";
                    statusEl.className = "text-[7px] font-black text-emerald-600 bg-emerald-50 p-1 rounded border border-emerald-100 uppercase";
                }
            } catch (err) {
                logToSystem("Loxo Sync: Handshake error (CORS or Key).");
                if (statusEl) statusEl.textContent = "Sync Error";
            }
        };

        // CSV UPLOAD
        document.getElementById('csv-upload').addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (!file) return;
            Papa.parse(file, {
                header: true, skipEmptyLines: true, transformHeader: h => h.trim().toLowerCase().replace(/[^a-z0-9 ]/g, ""),
                complete: async function(results) {
                    const data = results.data;
                    const isLeads = data[0]['job title'] || data[0]['title'] || data[0]['role'];
                    const total = data.length;
                    for (let i = 0; i < total; i++) {
                        const row = data[i];
                        if (isLeads) {
                            const orgName = row['organisation'] || row['charity'];
                            if (orgName) {
                                await window.saveIntelligence({
                                    charityName: orgName,
                                    charityNumber: (row['charity number'] || "").toString(),
                                    foundAt: new Date().toISOString(),
                                    jobs: [{
                                        title: row['job title'] || row['title'],
                                        salary: row['salary'],
                                        link: row['link'] || row['url'],
                                        closing: row['closing'] || "TBC",
                                        behaviorFlag: row['reason'] || row['note'] || "Lead",
                                        reportsTo: row['reports to'] || "CEO",
                                        reportsToName: row['reports to name'] || "",
                                        agencyScore: row['score'] || 5
                                    }]
                                }, true);
                            }
                        } else {
                            const rawName = row['charity name'] || row['organisation'] || row['name'];
                            if (rawName) {
                                const charityNumber = (row['charity number'] || "").toString().trim();
                                const income = parseInt((row['last recorded income'] || "0").replace(/[^0-9]/g, ''));
                                const status = row['loxo status'] || "Target";
                                let existingIdx = -1;
                                if (charityNumber) existingIdx = masterRegistry.findIndex(m => m.charityNumber === charityNumber);
                                if (existingIdx === -1) existingIdx = masterRegistry.findIndex(m => cleanName(m.name) === cleanName(rawName));
                                if (existingIdx > -1) {
                                    if (status !== "Target") masterRegistry[existingIdx].loxo = status;
                                    if (income > 0) masterRegistry[existingIdx].income = income;
                                } else {
                                    masterRegistry.push({ name: rawName, charityNumber, income, loxo: status, batch: (i % 10) + 1 });
                                }
                            }
                        }
                        if (i % 100 === 0) updateProgressBar((i / total) * 100, "Updating Mission Parameters...", `${i} of ${total}`);
                    }
                    localStorage.setItem('local_registry', JSON.stringify(masterRegistry));
                    updateProgressBar(100, "Data Merged!", `${total} processed.`, true);
                    window.renderTable();
                    updateMetricsUI();
                }
            });
        });

        window.startScan = async function(charityName) {
            if (!activeApiKey) { toggleSettings(); return; }
            logToSystem(`Grounded Hierarchy Search: ${charityName}...`);
            const prompt = `Perform grounded behavioral search for senior vacancies (>£40k) at ${charityName}. 
            1. Extract Title, Salary, URL, Closing.
            2. Identify Line Manager Title (e.g. Reports to CEO) AND try to identify the Name of that person (e.g. CEO is John Smith).
            3. Calculate Agency Propensity Score (1-10).
            4. Detailed reason for agency need.
            Return STRICTLY JSON: {"jobs": [{"title": "Role", "salary": "£50k", "link": "url", "closing": "Date", "reportsTo": "Title", "reportsToName": "Name", "agencyScore": 8, "behaviorFlag": "Narrative"}]}`;

            try {
                const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key=${activeApiKey}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }], tools: [{ "google_search": {} }] })
                });
                const data = await response.json();
                let rawText = data.candidates?.[0]?.content?.parts?.[0]?.text || "{}";
                const parsed = JSON.parse(rawText.replace(/```json/g, '').replace(/```/g, '').trim());
                if (parsed.jobs) await window.saveIntelligence({ charityName, foundAt: new Date().toISOString(), jobs: parsed.jobs, sentiment: parsed.sentiment || {} });
            } catch (err) { logToSystem("Scan Error."); }
        };

        window.saveIntelligence = async function(entry, silent = false) {
            trackedIntelligence.unshift(entry);
            localStorage.setItem('local_intel', JSON.stringify(trackedIntelligence));
            if (db) await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'leads'), entry);
            if (!silent) { window.renderTable(); updateMetricsUI(); }
        };

        window.renderTable = function() {
            const tbody = document.getElementById('table-body');
            const search = (document.getElementById('search-input')?.value || "").toLowerCase();
            if (!tbody) return;
            const filtered = masterRegistry.filter(c => (c.name || "").toLowerCase().includes(search) || (c.charityNumber || "").includes(search));
            
            tbody.innerHTML = filtered.slice(0, 50).map(c => {
                const discoveries = trackedIntelligence.filter(j => (c.charityNumber && j.charityNumber === c.charityNumber) || (cleanName(j.charityName) === cleanName(c.name)));
                const latest = discoveries[0] || { jobs: [] };
                const actionData = teamActions[c.name.replace(/[^a-zA-Z0-9]/g, "-")];
                const isActioned = !!actionData;

                return `
                    <tr class="hover:bg-white border-b border-slate-50 transition-all ${isActioned ? 'actioned-row' : ''}">
                        <td class="px-10 py-8">
                            <div class="font-black uppercase text-lg tracking-tighter text-slate-800 leading-tight">${c.name}</div>
                            <div class="flex flex-wrap gap-2 mt-2">
                                <span class="urgency-badge ${c.loxo === 'Client' ? 'bg-blue-100 text-blue-600' : 'bg-slate-100 text-slate-400'}">${c.loxo || 'Target'}</span>
                                ${isActioned ? `<span class="urgency-badge bg-emerald-100 text-emerald-700 font-bold italic">CLAIMED: ${actionData.actionedBy}</span>` : ''}
                            </div>
                        </td>
                        <td class="px-10 py-8">
                            <div class="grid grid-cols-1 lg:grid-cols-2 gap-4">
                                ${latest.jobs.map(j => `
                                    <div class="p-4 rounded-2xl shadow-sm salaried-card relative overflow-hidden">
                                        <span class="absolute top-0 right-0 ${getScoreColor(j.agencyScore)} px-2 py-0.5 rounded-bl uppercase font-black text-[7px]">Score: ${j.agencyScore}/10</span>
                                        <div class="text-[9px] font-black uppercase text-slate-900 leading-tight pr-14">${j.title}</div>
                                        <div class="text-[8px] font-bold text-blue-600 mt-1 uppercase italic underline">Reports to: ${j.reportsToName || j.reportsTo || 'TBC'}</div>
                                    </div>
                                `).join('') || '<div class="text-[8px] text-slate-300 italic py-2">No opportunity artifacts scanned.</div>'}
                            </div>
                        </td>
                        <td class="px-10 py-8 text-right">
                            ${isActioned ? `<span class="text-[10px] font-black text-emerald-600 uppercase italic">In Pipeline</span>` : `
                                <div class="flex flex-col items-end gap-2">
                                    <select id="team-${c.name.replace(/[^a-zA-Z0-9]/g, "-")}" class="text-[10px] font-bold border border-slate-200 px-3 py-1 rounded-lg outline-none">
                                        <option>Select...</option><option>Tim</option><option>Rory</option><option>Anton</option>
                                    </select>
                                    <button onclick="actionJob('${c.name}', document.getElementById('team-${c.name.replace(/[^a-zA-Z0-9]/g, "-")}').value)" class="bg-slate-900 text-white text-[10px] px-6 py-2 rounded-xl font-black uppercase shadow-md active:scale-95 transition-all">Claim opportunity</button>
                                </div>`}
                        </td>
                    </tr>
                `;
            }).join('');
        };

        window.renderLeadsModal = function() {
            const tbody = document.getElementById('leads-modal-body');
            if (!tbody) return;
            const allLeads = [];
            trackedIntelligence.forEach(entry => entry.jobs.forEach(job => allLeads.push({ charity: entry.charityName, ...job })));
            allLeads.sort((a,b) => (b.agencyScore || 0) - (a.agencyScore || 0));

            tbody.innerHTML = allLeads.map((lead, idx) => {
                const actionData = teamActions[lead.charity.replace(/[^a-zA-Z0-9]/g, "-")];
                const isActioned = !!actionData;
                return `
                    <tr class="${isActioned ? 'opacity-50' : ''} border-b border-slate-100">
                        <td class="py-6 px-2 font-black uppercase text-[10px] text-slate-900 leading-tight">${lead.charity}</td>
                        <td class="py-6 px-2">
                            <div class="font-bold text-[10px] text-blue-600 uppercase tracking-tighter italic leading-none">${lead.title}</div>
                            <div class="text-[8px] font-bold text-slate-500 mt-2 uppercase">Reporting to: <span class="text-blue-500">${lead.reportsToName || lead.reportsTo || 'Missing'}</span></div>
                        </td>
                        <td class="py-6 px-2 text-center">
                            <span class="score-pill ${getScoreColor(lead.agencyScore)}">${lead.agencyScore}/10</span>
                        </td>
                        <td class="py-6 px-2 max-w-xs text-[9px] font-medium leading-relaxed italic text-slate-500">
                            ${lead.behaviorFlag || 'Priority Opportunity'}
                            <div id="loxo-status-${idx}" class="mt-2 text-[7px] font-black uppercase text-slate-300 italic">Loxo Link Ready</div>
                        </td>
                        <td class="py-6 px-2 text-right">
                            <div class="flex items-center justify-end gap-2">
                                <a href="${lead.link}" target="_blank" class="p-2 bg-slate-100 rounded-lg hover:bg-slate-200"><svg class="w-4 h-4 text-slate-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14"></path></svg></a>
                                <button onclick="window.syncToLoxo('${encodeURIComponent(JSON.stringify(lead))}', ${idx})" class="bg-blue-600 text-white px-3 py-1.5 rounded-xl text-[9px] font-black italic uppercase shadow-md hover:bg-blue-700 transition-all">Add to Loxo</button>
                                ${isActioned ? `<span class="text-[8px] font-black text-emerald-600 uppercase italic">By ${actionData.actionedBy}</span>` : `<button onclick="actionJob('${lead.charity}', 'Tim')" class="bg-slate-900 text-white text-[8px] font-black px-2 py-1.5 rounded uppercase">Claim</button>`}
                            </div>
                        </td>
                    </tr>`;
            }).join('');
        };

        window.exportHistoryCSV = function() {
            let csv = "Charity,JobTitle,Salary,AgencyScore,ReportsTo,ReportsToName,Reason,ActionedBy,Date\n";
            trackedIntelligence.forEach(i => (i.jobs||[]).forEach(j => {
                const action = teamActions[i.charityName.replace(/[^a-zA-Z0-9]/g, "-")];
                csv += `"${i.charityName}","${j.title}","${j.salary}","${j.agencyScore}","${j.reportsTo}","${j.reportsToName}","${j.behaviorFlag}","${action ? action.actionedBy : 'Unclaimed'}","${i.foundAt}"\n`;
            }));
            const link = document.createElement('a'); link.href = encodeURI("data:text/csv;charset=utf-8," + csv); link.download = 'Strategic_Lead_History.csv'; link.click();
        };

        function updateMetricsUI() {
            document.getElementById('stat-total').textContent = masterRegistry.length;
            document.getElementById('stat-clients').textContent = masterRegistry.filter(c => c.loxo === 'Client').length;
            document.getElementById('stat-actioned').textContent = Object.keys(teamActions).length;
            document.getElementById('stat-leads').textContent = trackedIntelligence.reduce((acc, curr) => acc + (curr.jobs?.length || 0), 0);
        }

        window.toggleAutoPilot = async function() {
            if (!activeApiKey) { toggleSettings(); return; }
            autoPilotActive = !autoPilotActive;
            const btn = document.getElementById('auto-pilot-btn');
            if (autoPilotActive) {
                btn.innerHTML = `Stop Sync`; btn.classList.replace('bg-emerald-600', 'bg-red-600');
                const today = new Date().getDay() || 1;
                const scanQueue = masterRegistry.filter(c => c.batch === today);
                for (let i = 0; i < scanQueue.length; i++) {
                    if (!autoPilotActive) break;
                    document.getElementById('scan-progress').textContent = scanQueue[i].name;
                    updateProgressBar((i / scanQueue.length) * 100, "Evaluating Lead Propensity...", `Processing ${i} of ${scanQueue.length}`);
                    await startScan(scanQueue[i].name);
                    await new Promise(r => setTimeout(r, 12000));
                }
                updateProgressBar(100, "Mission Finalized!", `Opportunities Ready.`, true);
                toggleAutoPilot();
            } else { btn.innerHTML = `Start Sweep`; btn.classList.replace('bg-red-600', 'bg-emerald-600'); }
        };

        document.getElementById('search-input')?.addEventListener('input', window.renderTable);
        init();
    </script>
</body>
</html>
